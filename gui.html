<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eidos Agent - Pathos Interface</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✻</text></svg>" type="image/svg+xml">

    <!-- Prism.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism-tomorrow.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            height: 100vh;
            margin: 0;
            background-color: #1C1C1C; 
            color: #FFFFFF; 
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            overflow: hidden; 
        }

        .container-wrapper {
            display: flex;
            width: 100%;
            max-width: 1200px; 
            height: 95vh;
            gap: 10px; 
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%; 
            flex-grow: 1; 
            max-width: 800px; 
            border: 1px solid #333333; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25); 
            background-color: #1C1C1C; 
            overflow: hidden;
            transition: height 0.5s ease, max-height 0.5s ease;
        }

        .chat-container.minimized {
            height: auto;
            max-height: 180px; 
        }

        .header-section { 
            padding: 16px;
            background-color: #1C1C1C; 
            border-bottom: 1px solid #333333;
            position: relative;
        }

            .header-section label:not(.collapsible-header-label) { 
                font-weight: 600;
                margin-bottom: 8px;
                display: block;
                font-size: 14px;
                color: #FFFFFF; 
            }

            .header-section select,
            .header-section textarea {
                width: 100%;
                padding: 8px 12px;
                font-size: 14px;
                line-height: 20px;
                color: #FFFFFF; 
                background-color: #2D2D2D; 
                border: 1px solid #444444; 
                border-radius: 8px;
                box-shadow: none;
                vertical-align: middle;
                box-sizing: border-box; 
            }

                .header-section select:focus,
                .header-section textarea:focus {
                    border-color: #F97B65; 
                    outline: none;
                    box-shadow: 0 0 0 2px rgba(249, 123, 101, 0.4);
                }

        .model-selector { 
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .model-selector label {
                margin-bottom: 0; 
                flex-shrink: 0;
            }

            .model-selector select {
                flex-grow: 1;
                background-color: #2D2D2D;
                color: #FFFFFF;
                appearance: none;
                padding-right: 24px;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 8px center;
                background-size: 16px;
            }

        .header-tool-icon { 
            position: absolute;
            top: 15px;
            width: 40px;
            height: 40px;
            background-color: transparent;
            color: #F97B65;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10; 
            transition: all 0.2s ease;
        }

        #system-prompt-button { 
            right: 15px;
        }

        #history-button { 
            left: 15px;
        }

        #proactive-button {
            right: 60px; 
        }
        #learning-log-button { 
            right: 105px; 
        }
        #dream-journal-button { 
            right: 150px; 
        }
        #knowledge-log-button { 
            right: 195px; 
        }


        .chat-container.minimized .header-tool-icon { 
            top: 10px;
            width: 30px;
            height: 30px;
        }

        .chat-container.minimized #system-prompt-button { 
            right: 10px;
        }

        .chat-container.minimized #history-button { 
            left: 10px;
        }

        .chat-container.minimized #proactive-button {
            right: 45px; 
        }
        .chat-container.minimized #learning-log-button { 
            right: 80px;
        }
        .chat-container.minimized #dream-journal-button {
            right: 115px; 
        }
        .chat-container.minimized #knowledge-log-button {
            right: 150px; 
        }


        .header-tool-icon:hover { 
            background-color: rgba(255, 255, 255, 0.05);
            transform: scale(1.05);
        }

        .system-prompt-panel, .history-panel, .proactive-panel, .learning-log-panel, .dream-journal-panel, .knowledge-log-panel, .daily-briefing-panel { /* Added .daily-briefing-panel */
            position: fixed; 
            top: 0;
            width: 320px; 
            height: 100%;
            background-color: #2D2D2D;
            padding: 20px;
            box-sizing: border-box;
            transition: right 0.3s ease, left 0.3s ease; 
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }

        .system-prompt-panel, .proactive-panel, .learning-log-panel, .dream-journal-panel, .knowledge-log-panel, .daily-briefing-panel { /* Panels sliding from right */
             right: -350px; 
             border-left: 1px solid #444444; 
        } 
        .history-panel { /* Panel sliding from left */
            left: -350px; 
            border-right: 1px solid #444444; 
        } 

        .system-prompt-panel.open, .proactive-panel.open, .learning-log-panel.open, .dream-journal-panel.open, .knowledge-log-panel.open, .daily-briefing-panel.open { right: 0; }
        .history-panel.open { left: 0; }


        .panel-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #444444;
            padding-bottom: 10px;
        }

        .panel-header span {
            font-size: 18px;
            font-weight: 500;
            color: #F97B65;
        }

        .panel-header button {
            background: transparent;
            border: none;
            color: #BBBBBB;
            font-size: 24px;
            cursor: pointer;
        }

        .panel-header button:hover {
            color: #FFFFFF;
        }

        .settings-section {
            margin-bottom: 15px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid #444444; 
        }

        .settings-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .settings-section label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            font-size: 14px;
            color: #FFFFFF; 
        }

        .settings-section input[type="text"],
        .settings-section input[type="password"],
        .settings-section input[type="number"], 
        .settings-section textarea {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            line-height: 20px;
            color: #FFFFFF; 
            background-color: #1C1C1C; 
            border: 1px solid #444444; 
            border-radius: 8px;
            box-shadow: none;
            vertical-align: middle;
            box-sizing: border-box; 
        }

        .settings-section input[type="text"]:focus,
        .settings-section input[type="password"]:focus,
        .settings-section input[type="number"]:focus, 
        .settings-section textarea:focus {
            border-color: #F97B65; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(249, 123, 101, 0.4);
        }


        .history-content, .proactive-content, .learning-log-content, .dream-journal-content, .knowledge-log-content, .daily-briefing-content { /* Added .daily-briefing-content */
            flex-grow: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #444444 #1C1C1C;
        }

        .history-content::-webkit-scrollbar, .proactive-content::-webkit-scrollbar, .learning-log-content::-webkit-scrollbar, .dream-journal-content::-webkit-scrollbar, .knowledge-log-content::-webkit-scrollbar, .daily-briefing-content::-webkit-scrollbar {
            width: 8px;
        }

        .history-content::-webkit-scrollbar-track, .proactive-content::-webkit-scrollbar-track, .learning-log-content::-webkit-scrollbar-track, .dream-journal-content::-webkit-scrollbar-track, .knowledge-log-content::-webkit-scrollbar-track, .daily-briefing-content::-webkit-scrollbar-track {
            background: #1C1C1C;
        }

        .history-content::-webkit-scrollbar-thumb, .proactive-content::-webkit-scrollbar-thumb, .learning-log-content::-webkit-scrollbar-thumb, .dream-journal-content::-webkit-scrollbar-thumb, .knowledge-log-content::-webkit-scrollbar-thumb, .daily-briefing-content::-webkit-scrollbar-thumb {
            background-color: #444444;
            border-radius: 10px;
            border: 2px solid #1C1C1C;
        }

        .history-item { 
            padding: 10px;
            margin-bottom: 8px;
            background-color: #1C1C1C;
            border: 1px solid #444444;
            border-radius: 6px;
            cursor: default; 
            font-size: 14px;
        }

        .history-item[data-history-index]:hover { 
             background-color: #383838;
             border-color: #F97B65;
             cursor: pointer;
        }


        .history-item-date {
            font-size: 12px;
            color: #888888;
            margin-bottom: 4px;
        }

        .proactive-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #1C1C1C;
            border: 1px solid #444444;
            border-left: 3px solid #5A9BFF; 
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer; 
            transition: background-color 0.2s ease, border-color 0.2s ease; 
        }
        .proactive-item:hover { 
            background-color: #252525;
            border-left-color: #F97B65;
        }
        .proactive-item-date {
             font-size: 12px;
             color: #888888;
             margin-bottom: 4px;
        }


        .collapsible-header {
            cursor: pointer;
            padding: 8px 0;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #FFFFFF; 
        }

            .collapsible-header:hover {
                color: #F97B65; 
            }

        .toggle-icon {
            font-family: monospace;
            font-weight: bold;
            margin-left: 5px;
            display: inline-block;
            width: 20px;
            text-align: center;
            color: #F97B65; 
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background-color: #1C1C1C; 
            background-image: linear-gradient(to bottom, #1A1A1A, #212121); 
            scrollbar-width: thin;
            scrollbar-color: #444444 #1C1C1C;
            transition: max-height 0.5s ease, opacity 0.5s ease, padding 0.4s ease;
        }

        .chat-messages.minimized {
            max-height: 0;
            min-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
            overflow: hidden;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #1C1C1C;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #444444;
            border-radius: 10px;
            border: 2px solid #1C1C1C;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.5;
            border: none; 
        }

            .message-bubble .message-sender {
                font-size: 13px;
                font-weight: 600;
                margin-bottom: 4px;
                color: #F97B65; 
            }

            .message-bubble .message-timestamp {
                font-size: 12px;
                color: #888888;
                text-align: right;
                margin-top: 8px;
            }

        .user-message {
            background-color: #2D2D2D; 
            color: #FFFFFF;
            align-self: flex-end;
            border-radius: 12px 12px 2px 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .ai-message {
            background-color: #383838; 
            color: #FFFFFF;
            align-self: flex-start;
            border-left: 3px solid #F97B65; 
            border-radius: 2px 12px 12px 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

            .ai-message .typing-indicator {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 8px 0;
            }

            .ai-message .typing-indicator span {
                display: inline-block;
                width: 8px;
                height: 8px;
                background-color: #F97B65;
                border-radius: 50%;
                opacity: 0.6;
                animation: typing-animation 1.4s infinite ease-in-out both;
            }

            .ai-message .typing-indicator span:nth-child(1) {
                animation-delay: 0s;
            }

            .ai-message .typing-indicator span:nth-child(2) {
                animation-delay: 0.2s;
            }

            .ai-message .typing-indicator span:nth-child(3) {
                animation-delay: 0.4s;
            }

            @keyframes typing-animation {
                0%, 80%, 100% {
                    transform: scale(0.6);
                    opacity: 0.4;
                }
                40% {
                    transform: scale(1);
                    opacity: 1;
                }
            }

        .collapsible-think-section {
            margin: 10px 0;
            border: 1px dashed #F97B65; 
            border-radius: 8px;
            background-color: #2D2D2D;
        }

            .collapsible-think-section .think-header {
                cursor: pointer;
                background-color: #3D3D3D;
                color: #F97B65; 
                padding: 8px 12px;
                font-size: 0.9em;
                font-weight: 500;
                border-bottom: 1px dashed #F97B65;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

                .collapsible-think-section .think-header:hover {
                    background-color: #4A4A4A;
                }

            .collapsible-think-section .think-content {
                padding: 12px;
                background-color: #252525;
                border-top: none;
                font-size: 0.95em;
                color: #DDDDDD;
            }

                .collapsible-think-section .think-content pre {
                    font-size: 80%;
                    background-color: #1A1A1A;
                }

        .message-content img {
            max-width: 100%; 
            height: auto;
            border-radius: 4px;
            margin-top: 8px; 
            display: block; 
        }

        .vision-analysis {
            margin-top: 10px;
            padding: 8px 12px;
            border-left: 3px solid #5A9BFF; 
            background-color: #2D2D2D;
            font-size: 0.9em;
            color: #BBBBBB;
            border-radius: 0 4px 4px 0;
        }
        .vision-analysis strong {
            color: #5A9BFF;
        }

        .message-footer-info {
            margin-top: 8px;
            font-size: 0.8em;
            color: #AAAAAA;
            text-align: right;
            border-top: 1px dashed #444444;
            padding-top: 4px;
        }
        .message-footer-info span {
            margin-left: 10px;
        }
        .message-footer-info strong {
            color: #DDDDDD;
        }

        .feedback-text-container {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #444444;
            display: flex; 
            gap: 8px; 
            align-items: flex-end; 
        }

        .feedback-text-container textarea {
            flex-grow: 1; 
            resize: vertical; 
            min-height: 40px; 
            max-height: 100px; 
            padding: 8px;
            border: 1px solid #444444;
            border-radius: 4px;
            background-color: #1A1A1A;
            color: #FFFFFF;
            font-family: inherit;
            font-size: 13px;
            box-sizing: border-box;
        }

        .feedback-text-container textarea:focus {
            border-color: #F97B65;
            outline: none;
            box-shadow: 0 0 0 1px rgba(249, 123, 101, 0.4);
        }

        .feedback-text-container button {
            flex-shrink: 0; 
            padding: 6px 12px;
            background-color: #F97B65;
            color: #FFFFFF;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .feedback-text-container button:hover {
            background-color: #FF8B75;
        }
        
        .chat-input-area {
            display: flex;
            flex-direction: column; 
            padding: 12px 16px; 
            border-top: 1px solid #333333;
            background-color: #1C1C1C;
            gap: 10px; 
            align-items: stretch; 
            position: relative;
            transition: all 0.3s ease;
        }

        .chat-container.minimized .chat-input-area {
            padding: 12px;
            border-top: none;
        }
        
        .action-buttons-row {
            display: flex;
            justify-content: space-around; 
            align-items: center;
            margin-bottom: 8px; 
            padding: 4px 0; 
            border-bottom: 1px solid #2a2a2a; 
            width: 100%;
        }

        .action-buttons-row .icon-button {
            margin: 0 4px; 
            cursor: pointer; 
            z-index: 5; 
        }

        .input-row {
            display: flex;
            flex-direction: row; 
            align-items: center; 
            gap: 10px; 
            width: 100%; 
        }
        
        .input-container {
            position: relative;
            flex-grow: 1; 
            display: flex;
            align-items: center; 
            background-color: #2D2D2D;
            border-radius: 24px; 
            border: 1px solid #444444;
            transition: all 0.2s ease;
            padding: 10px 16px; 
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .input-container:focus-within {
            border-color: #F97B65;
            box-shadow: 0 0 0 2px rgba(249, 123, 101, 0.4), 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }

        #model-dropdown-button {
            display: flex;
            align-items: center;
            background-color: rgba(255,255,255,0.05);
            padding: 5px 10px;
            margin-right: 10px;
            border-radius: 12px;
            font-size: 13px;
            color: #DDDDDD;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            white-space: nowrap;
            min-width: 80px;
            flex-shrink: 0;
        }

        #model-dropdown-button:hover {
            background-color: rgba(249, 123, 101, 0.1);
            color: #FFFFFF;
        }

        .dropdown-arrow {
            display: inline-block;
            margin-left: 6px;
            font-size: 12px;
            line-height: 1;
            color: #F97B65;
            font-weight: bold;
        }

        #model-dropdown-content {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 5px;
            background-color: #2D2D2D;
            min-width: 180px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.4);
            border-radius: 8px;
            z-index: 100;
            scrollbar-width: thin;
            scrollbar-color: #444444 #1C1C1C;
            border: 1px solid #444444;
        }

        #model-dropdown-content div {
            padding: 8px 12px;
            text-align: left;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 13px;
        }

        #model-dropdown-content div:hover {
            background-color: #3D3D3D;
        }

        #model-dropdown-content div.selected {
            background-color: rgba(249, 123, 101, 0.2);
            color: #F97B65;
        }

        .claude-header {
            position: relative;
            text-align: center;
            padding: 30px 0 15px;
            transition: all 0.5s ease;
        }

        .coral-icon {
            color: #F97B65;
            font-size: 28px;
            margin-right: 12px;
            transition: all 0.5s ease;
        }

        .welcome-text {
            font-size: 24px;
            color: #DDDDDD;
            font-weight: 400;
            transition: all 0.5s ease;
        }

        .chat-active .claude-header {
            padding: 20px 0 15px;
        }

        .chat-active .coral-icon {
            font-size: 20px;
        }

        .chat-active .welcome-text {
            font-size: 20px;
        }

        .chat-container.minimized .claude-header {
            padding: 20px 0 5px;
        }

        .icon-button { 
            background-color: #2D2D2D;
            border: 1px solid #444444;
            cursor: pointer;
            padding: 0;
            color: #888888;
            border-radius: 8px;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            overflow: hidden;
        }
        .input-container .icon-button { 
            margin-left: 4px; 
            margin-right: 4px;
            width: 38px; 
            height: 38px;
            border-radius: 50%; 
            flex-shrink: 0;
        }


        .icon-button:hover {
            background-color: #3D3D3D;
            color: #F97B65;
            border-color: #F97B65;
        }
        
        .icon-button.listening {
            background-color: #F97B65; 
            color: #FFFFFF; 
            border-color: #FF8B75; 
            animation: pulse-animation 1.5s infinite;
        }

        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(249, 123, 101, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(249, 123, 101, 0); }
            100% { box-shadow: 0 0 0 0 rgba(249, 123, 101, 0); }
        }
        
        .chat-input-area textarea#user-input { 
            flex-grow: 1;
            resize: none;
            padding: 8px 4px; 
            border: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 20px; 
            background-color: transparent;
            color: #FFFFFF;
            box-shadow: none;
            min-height: 24px; 
            max-height: 120px; 
            overflow-y: auto; 
            transition: height 0.1s ease-out; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
        }

        .chat-input-area textarea#user-input:focus {
            outline: none;
        }
            
        #send-button {
            background-color: #F97B65; 
            border-radius: 50%; 
            width: 38px;  
            height: 38px; 
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            margin-left: 4px; 
            flex-shrink: 0; 
        }

        #send-button:hover {
            background-color: #FF8B75; 
            transform: scale(1.05);
        }

        #send-button:disabled {
            background-color: #A25246;
            color: rgba(255,255,255,0.6);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }


        /* Markdown specific styles */
        .message-content pre {
            background-color: #1A1A1A; 
            color: #EAEAEA;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 85%;
            line-height: 1.45;
            border: 1px solid #444444;
        }

        .message-content code:not(pre code) {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 6px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            color: #F97B65; 
        }

        .message-content table {
            border-collapse: collapse;
            margin: 1em 0;
            display: block;
            width: max-content;
            max-width: 100%;
            overflow: auto;
        }

        .message-content th, .message-content td {
            border: 1px solid #444444;
            padding: 6px 13px;
            text-align: left;
        }

        .message-content th {
            background-color: #2D2D2D;
            font-weight: 600;
        }

        .message-content blockquote {
            border-left: .25em solid #F97B65; 
            padding: 0 1em;
            color: #AAAAAA;
            margin-left: 0;
            margin-right: 0;
        }

        .message-content hr {
            height: .25em;
            padding: 0;
            margin: 24px 0;
            background-color: #444444;
            border: 0;
        }

        .message-content ul, .message-content ol {
            padding-left: 2em;
        }

        .message-content h1, .message-content h2, .message-content h3, .message-content h4, .message-content h5, .message-content h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }

        .message-content h1 {
            font-size: 2em;
            padding-bottom: .3em;
            border-bottom: 1px solid #d8dee4;
        }

        .message-content h2 {
            font-size: 1.5em;
            padding-bottom: .3em;
            border-bottom: 1px solid #d8dee4;
        }

        .message-content h3 {
            font-size: 1.25em;
        }

        .message-content h4 {
            font-size: 1em;
        }

        #attached-document-indicator {
            font-size: 0.8em;
            color: #BBBBBB;
            margin-top: 5px;
            padding: 5px 10px;
            background-color: #2D2D2D;
            border: 1px solid #444444;
            border-radius: 4px;
            display: none; 
            align-items: center;
            gap: 5px;
        }
        #attached-document-indicator svg {
            width: 16px;
            height: 16px;
            color: #F97B65;
        }
        #attached-document-indicator span {
            flex-grow: 1;
        }
        #attached-document-indicator button {
            background: transparent;
            border: none;
            color: #BBBBBB;
            font-size: 16px;
            cursor: pointer;
            padding: 0 5px;
        }
        #attached-document-indicator button:hover {
            color: #FFFFFF;
        }

        .document-content-display {
            margin-bottom: 10px; 
            padding: 10px;
            background-color: #1A1A1A; 
            border: 1px dashed #444444; 
            border-radius: 4px;
            font-size: 0.9em;
            color: #DDDDDD;
            overflow-x: auto; 
        }
        .document-content-display strong {
            color: #F97B65; 
        }
        .document-content-display pre {
             margin: 0; 
             padding: 0; 
             background-color: transparent; 
             border: none; 
             color: inherit; 
             font-size: inherit; 
             font-family: inherit; 
             white-space: pre-wrap; 
             word-wrap: break-word; 
        }

        .input-container.drag-over {
            border-color: #5A9BFF; 
            box-shadow: 0 0 0 3px rgba(90, 155, 255, 0.5); 
            background-color: #383838; 
        }

        #weather-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 200px; 
            background-color: #2D2D2D;
            border: 1px solid #444444;
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            color: #DDDDDD;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            z-index: 990; 
            display: flex; 
            flex-direction: column;
            gap: 5px; 
        }

        .weather-header {
             font-weight: bold;
             color: #F97B65; 
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding-bottom: 5px;
             margin-bottom: 5px;
             border-bottom: 1px solid #444444;
        }

        .weather-header button {
             background: transparent;
             border: none;
             color: #BBBBBB;
             font-size: 18px; 
             cursor: pointer;
             padding: 0 5px;
             margin-left: 5px;
        }

        #weather-update-button {
             padding: 0 3px; 
             font-size: 16px; 
        }


        .weather-header button:hover {
             color: #FFFFFF;
        }

        #weather-location {
            font-weight: 600;
            color: #FFFFFF;
        }

        #weather-temperature {
            font-size: 14px;
            font-weight: bold;
        }

        #weather-description, 
        #weather-humidity,
        #weather-wind {
            color: #BBBBBB;
        }


        #weather-last-updated {
            font-size: 10px;
            color: #888888;
            text-align: right;
            margin-top: 5px;
        }
        
        .panel-actions {
            margin-top: auto; 
            padding-top: 15px;
            border-top: 1px solid #444444;
            display: flex;
            gap: 10px; 
            justify-content: flex-end; 
        }

        .panel-actions button {
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            background-color: #3D3D3D;
            color: #FFFFFF;
            border: 1px solid #555555;
        }

        .panel-actions button:hover {
            background-color: #4A4A4A;
            border-color: #F97B65;
        }

        .panel-actions button[id*="clear-"] { 
            background-color: #52302B; 
            border-color: #70403A;
        }
        .panel-actions button[id*="clear-"]:hover {
            background-color: #6F403A; 
            border-color: #F97B65;
        }

        #dream-journal-button { right: 150px; } 
        #knowledge-log-button { right: 195px; } 


        .dream-journal-item {
            padding: 12px;
            margin-bottom: 10px;
            background-color: #1F1F1F; 
            border: 1px solid #383838;
            border-left: 3px solid #7E57C2; 
            border-radius: 6px;
            font-size: 14px;
        }
        .dream-journal-item .dream-timestamp {
            font-size: 0.8em;
            color: #999999;
            margin-bottom: 5px;
        }
        .dream-journal-item .dream-content {
            margin-bottom: 10px;
        }
        .dream-journal-item .dream-image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-top: 8px;
            border: 1px solid #444;
        }
        .dream-journal-item .dream-seed-summary {
            font-size: 0.85em;
            color: #AAAAAA;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #333;
            font-style: italic;
        }

        .knowledge-log-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #1F1F1F;
            border: 1px solid #383838;
            border-left: 3px solid #4CAF50; 
            border-radius: 6px;
            font-size: 13px;
        }
        .knowledge-log-item .log-timestamp {
            font-size: 0.8em;
            color: #999999;
            margin-bottom: 3px;
        }
        .knowledge-log-item .log-fact {
            font-weight: 500;
            color: #D0D0D0;
            margin-bottom: 3px;
        }
        .knowledge-log-item .log-status {
            font-style: italic;
        }
        .knowledge-log-item .log-status.failed { 
            color: #E57373;
            font-style: italic;
        }   
        .knowledge-log-item .log-status.accurate { color: #81C784; }
        .knowledge-log-item .log-status.updated { color: #FFB74D; }
        .knowledge-log-item .log-status.unverifiable { color: #E57373; }
        .knowledge-log-item .log-new-statement {
            margin-top: 5px;
            padding-left: 10px;
            border-left: 2px solid #555;
            font-size: 0.95em;
        }

        .proactive-reply-context-display { /* Style for the temporary display */
        padding: 5px 0px 8px 0px;
        font-size: 0.9em;
        color: #aaa;
        font-style: italic;
        border-bottom: 1px dashed #333;
        margin-bottom: 8px;
        }
    
    </style>
</head>
<body>

    <div class="container-wrapper">
        <div class="chat-container">
            <div class="header-section model-selector" style="display: none;">
                <select id="model-select">
                    <option value="">Loading models...</option>
                </select>
            </div>

            <div id="history-button" class="header-tool-icon" title="View Chat History">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>

            <div id="proactive-button" class="header-tool-icon" title="View Proactive Messages">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                     <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                 </svg>
            </div>
             <div id="learning-log-button" class="header-tool-icon" title="View Agent Learnings"> 
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                    <path d="M12 8v4l2 1"></path> 
                </svg>
            </div>

            <div id="dream-journal-button" class="header-tool-icon" title="View Dream Journal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path> 
                </svg>
            </div>
            <div id="knowledge-log-button" class="header-tool-icon" title="View Knowledge Upkeep Log">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                    <line x1="16" y1="13" x2="16" y2="21"></line>
                    <line x1="12" y1="13" x2="12" y2="21"></line>
                    <line x1="8" y1="13" x2="8" y2="21"></line>
                </svg>
            </div>

            <div id="system-prompt-button" class="header-tool-icon" title="View Settings"> 
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                </svg>
            </div>


            <div class="claude-header">
                <span class="coral-icon">✻</span>
                <span class="welcome-text">How's it going?</span>
            </div>

            <div class="chat-messages" id="chat-messages-area">
            </div>

            <div class="chat-input-area">
                <div class="action-buttons-row">
                    <input type="file" id="document-input" style="display: none;" accept=".pdf,.docx,.txt">
                    <button id="upload-document-button" class="icon-button" title="Upload a document (PDF, DOCX, TXT)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="transform: scale(1.1);">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="17" x2="12" y2="11"></line>
                            <line x1="9" y1="14" x2="15" y2="14"></line>
                        </svg>
                    </button>

                    <button id="get-daily-briefing-button" class="icon-button" title="Get Daily Briefing">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: scale(1.1);">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                        </svg>
                    </button>

                    <input type="file" id="image-input" style="display: none;" accept="image/*">
                    <button id="upload-image-button" class="icon-button" title="Upload an image">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="transform: scale(1.1);">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </button>

                    <button id="force-web-search-button" class="icon-button" title="Force web search for current input">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: scale(1.0);">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            <line x1="11" y1="8" x2="11" y2="14"></line>
                            <line x1="8" y1="11" x2="14" y2="11"></line>
                        </svg>
                    </button>
                    
                    <button id="reset-chat-button" class="icon-button" title="New chat">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: scale(1.1);">
                            <path d="M3.5 19.5L7 16"></path>
                            <path d="M14 8.5c1-1 2.5-1.5 4-1"></path>
                            <path d="M20.5 13c.5-1.5.5-3 0-4.5"></path>
                            <path d="M20 6.5c-1-.5-2.5-.5-4 0"></path>
                            <path d="M15.5 20.5c-1.5-1-3-2-4.5-4.5"></path>
                            <path d="M4 19l3.5-3.5"></path>
                            <path d="M13 8l7-4"></path>
                            <path d="M16 19c0-4 1.5-8 4-11"></path>
                        </svg>
                    </button>
                </div> 

                <div class="input-row"> 
                    <div class="input-container">
                        <div id="model-dropdown-button">
                            <span id="model-display-name">Eidos</span>
                            <span class="dropdown-arrow">▾</span>
                        </div>
                        <div id="model-dropdown-content">
                            <div>Loading models...</div>
                        </div>

                        <textarea id="user-input" placeholder="How can I help you today?" rows="1"></textarea>

                        <button id="microphone-button" class="icon-button" title="Start/Stop Voice Input">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>

                        <button id="send-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div> 

                <div id="attached-document-indicator">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span id="attached-document-name"></span>
                    <button id="remove-attached-document">×</button>
                </div>
            </div>
        </div>
        
        <div id="proactive-panel" class="proactive-panel">
            <div class="panel-header">
                <span>Proactive Thoughts</span>
                <button id="proactive-close-button">×</button>
            </div>
            <div class="proactive-content" id="proactive-messages-area">
                <p style="color: #888;">No proactive messages yet.</p>
            </div>
             <div class="panel-actions">
                 <button id="clear-proactive-button">Clear Display</button>
             </div>
        </div>
    
        <div id="weather-panel" style="display: none;"> 
            <div class="weather-header">
                Local Weather
                <button id="weather-update-button" title="Update Weather">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                         <path d="M21.5 2v6h-6M21.5 2a10 10 0 0 0-17 0m0 20v-6h6M2.5 22a10 10 0 0 0 17 0"></path>
                     </svg>
                </button>
                <button id="weather-close">×</button>
            </div>
            <div id="weather-location"></div>
            <div id="weather-temperature"></div>
            <div id="weather-description"></div>
            <div id="weather-humidity"></div>
            <div id="weather-wind"></div>
            <div id="weather-last-updated"></div>
        </div>
    
        <div id="daily-briefing-panel" class="system-prompt-panel"> 
            <div class="panel-header">
                <span>Daily Briefing</span>
                <button id="daily-briefing-close-button">×</button>
            </div>
            <div class="history-content" id="daily-briefing-content-area"> <!-- Reused class for scrollbar -->
                <p style="color: #888;">Click "Get Daily Briefing" to load today's briefing.</p>
            </div>
            <div class="panel-actions">
                 <button id="refresh-daily-briefing-button">Refresh Briefing</button>
            </div>
        </div>
    
        <div id="system-prompt-panel" class="system-prompt-panel">
            <div class="panel-header">
                <span>Settings</span>
                <button id="system-prompt-close">×</button>
            </div>
        
            <div class="settings-section">
                <label for="api-url-input">Eidos API Base URL:</label>
                <input type="text" id="api-url-input" placeholder="e.g., http://100.89.52.89:8088/v1">
            </div>
        
            <div class="settings-section">
                <label for="api-key-input">API Key (Optional):</label> 
                <input type="password" id="api-key-input" placeholder="Enter API Key if required"> 
            </div>
        
            <div class="settings-section">
                <label for="llm-provider-url-input">LLM Provider API Base URL:</label>
                <input type="text" id="llm-provider-url-input" placeholder="e.g., http://localhost:1234/v1">
            </div>
        
             <div class="settings-section">
                <label for="user-id-input">Your User ID:</label>
                <input type="text" id="user-id-input" placeholder="e.g., user_abc123">
             </div>
        
              <div class="settings-section">
                 <label for="weather-location-input">Default Weather Location:</label>
                 <input type="text" id="weather-location-input" placeholder="e.g., London, UK or New York, NY">
              </div>
        
            <div class="settings-section">
                <label for="model-temperature-input">Model Temperature (0.0 - 2.0):</label>
                <input type="number" id="model-temperature-input" min="0.0" max="2.0" step="0.1" value="0.7">
            </div>
        
            <div class="settings-section">
                <label for="context-length-input">Context Length (Max Tokens Override):</label>
                <input type="number" id="context-length-input" min="256" max="32000" step="128" placeholder="e.g., 4096">
            </div>
        
            <div class="settings-section">
                <label for="system-prompt-input">System Prompt:</label>
                <textarea id="system-prompt-input" placeholder="e.g., You are a helpful assistant that speaks like a pirate." rows="5"></textarea>
            </div>
        
            <div class="panel-actions">
                <button id="system-prompt-save">Save All Settings</button>
            </div>
        </div>
    
        <div id="history-panel" class="history-panel">
            <div class="panel-header">
                <span>Chat History</span>
                <button id="history-close-button">×</button>
            </div>
            <div class="history-content" id="history-content-area">
                <p style="color: #888;">No history yet. Chats are saved when you start a new chat.</p>
            </div>
            <div class="panel-actions">
                <button id="clear-history-button">Clear All History</button>
                <button id="clear-user-memory-button">Clear My Memory</button> 
                <button id="clear-backend-memory-button">Clear Eidos Memory</button>
            </div>
        </div>

        <div id="learning-log-panel" class="system-prompt-panel">
            <div class="panel-header">
                <span>Agent Learning Log</span>
                <button id="learning-log-close-button">×</button>
            </div>
            <div class="history-content" id="learning-log-content-area"> <!-- Reused class for scrollbar -->
                <p style="color: #888;">Fetching learnings...</p>
            </div>
            <div class="panel-actions">
                 <button id="refresh-learning-log-button">Refresh Log</button>
                 <button id="clear-learning-log-display-button">Clear Display</button>
            </div>
        </div>

        <div id="dream-journal-panel" class="system-prompt-panel">
            <div class="panel-header">
                <span>Dream Journal</span>
                <button id="dream-journal-close-button">×</button>
            </div>
            <div class="history-content" id="dream-journal-content-area"> <!-- Reused class for scrollbar -->
                <p style="color: #888;">Fetching dreams...</p>
            </div>
            <div class="panel-actions">
                 <button id="refresh-dream-journal-button">Refresh Dreams</button>
                 <button id="clear-dream-journal-display-button">Clear Display</button>
            </div>
        </div>

        <div id="knowledge-log-panel" class="system-prompt-panel">
            <div class="panel-header">
                <span>Knowledge Upkeep Log</span>
                <button id="knowledge-log-close-button">×</button>
            </div>
            <div class="history-content" id="knowledge-log-content-area"> <!-- Reused class for scrollbar -->
                <p style="color: #888;">Fetching knowledge upkeep log...</p>
            </div>
            <div class="panel-actions">
                 <button id="refresh-knowledge-log-button">Refresh Log</button>
                 <button id="clear-knowledge-log-display-button">Clear Display</button>
            </div>
        </div>

    </div> 

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' },
            startup: { ready: () => { console.log('MathJax is ready.'); MathJax.startup.defaultReady(); } }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script>
        // --- Configuration ---
        let EIDOS_API_BASE_URL = "http://localhost:8088/v1"; 
        const CHAT_HISTORY_KEY = 'eidosChatHistory';
        const USER_ID_KEY = 'eidosUserId';
        const SYSTEM_PROMPT_KEY = 'eidosSystemPrompt';
        const EIDOS_API_BASE_URL_KEY = 'eidosApiBaseUrl';
        const WEATHER_LOCATION_KEY = 'eidosWeatherLocation';
        const EIDOS_API_KEY_KEY = 'eidosApiKey';
        const MODEL_TEMPERATURE_KEY = 'eidosModelTemperature';
        const EIDOS_CONTEXT_LENGTH_KEY = 'eidosContextLength';
        const LLM_PROVIDER_URL_KEY = 'eidosLlmProviderUrl';
        const SELECTED_MODEL_KEY = 'eidosSelectedModel'; 


        // --- State Variables ---
        let conversationHistory = [];
        let isAwaitingResponse = false;
        let currentUserId;
        let eidosWebSocket = null;
        let attachedDocumentText = null;
        let attachedDocumentName = null;
        const THINK_TAG_PLACEHOLDER_PREFIX = "<!-- THINK_BLOCK_"; 
        const THINK_TAG_PLACEHOLDER_SUFFIX = "_END -->";
        let speechRecognition = null; 
        let isListening = false;     


        // --- DOM Elements ---
        let modelSelect, systemPromptInput, chatMessagesArea, userInput, sendButton, resetChatButton;
        let uploadDocumentButton, documentInput, uploadImageButton, imageInput;
        let systemPromptButton, systemPromptPanel, systemPromptClose, systemPromptSave;
        let historyButton, historyPanel, historyCloseButton, historyContentArea;
        let proactiveButton, proactivePanel, proactiveCloseButton, proactiveMessagesArea, clearProactiveButton;
        let attachedDocumentIndicator, attachedDocumentNameSpan, removeAttachedDocumentButton;
        let dropdownButton, dropdownContent, modelDisplayName;
        let modelTemperatureInput, contextLengthInput, forceWebSearchButton;
        let getDailyBriefingButton, dailyBriefingPanel, dailyBriefingCloseButton, dailyBriefingContentArea, refreshDailyBriefingButton;
        let clearHistoryButton, clearUserMemoryButton, clearBackendMemoryButton;
        let apiUrlInput, userIdInput, weatherLocationInput, apiKeyInput, llmProviderUrlInput;
        let weatherPanel, weatherLocationDisplay, weatherDescriptionDisplay, weatherTemperatureDisplay, weatherLastUpdatedDisplay, weatherCloseButton, weatherHumidityDisplay, weatherWindDisplay, weatherUpdateButton;
        let weatherUpdateInterval = null;
        let microphoneButton; 
        let learningLogButton, learningLogPanel, learningLogCloseButton, learningLogContentArea, refreshLearningLogButton, clearLearningLogDisplayButton;
        let dreamJournalButton, dreamJournalPanel, dreamJournalCloseButton, dreamJournalContentArea, refreshDreamJournalButton, clearDreamJournalDisplayButton;
        let knowledgeLogButton, knowledgeLogPanel, knowledgeLogCloseButton, knowledgeLogContentArea, refreshKnowledgeLogButton, clearKnowledgeLogDisplayButton;


        // --- Utility Functions ---
        async function fetchAndDisplayDailyBriefing() {
            if (!dailyBriefingContentArea) return;
            dailyBriefingContentArea.innerHTML = '<p style="color: #BBBBBB;">Fetching briefing...</p>';
            if (!EIDOS_API_BASE_URL) {
                 showNotification("Eidos API Base URL is not set in Settings.", "error");
                 dailyBriefingContentArea.innerHTML = '<p style="color: #F44336;">API URL not set.</p>';
                 return;
            }
            try {
                const response = await fetch(`${EIDOS_API_BASE_URL}/briefing`, {
                    method: 'GET',
                    headers: { 'X-User-Id': currentUserId }
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch briefing: ${response.status} ${errorText}`);
                }
                const result = await response.json();
                if (result.success && result.briefing_content) {
                    dailyBriefingContentArea.innerHTML = marked.parse(result.briefing_content);
                    Prism.highlightAllUnder(dailyBriefingContentArea);
                    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                         MathJax.typesetPromise([dailyBriefingContentArea]).catch(err => console.warn("MathJax (briefing):", err));
                    }
                } else if (result.message) {
                    dailyBriefingContentArea.innerHTML = `<p style="color: #BBBBBB;">${result.message}</p>`;
                } else {
                    dailyBriefingContentArea.innerHTML = '<p style="color: #F97B65;">Briefing not available or an error occurred.</p>';
                }
            } catch (error) {
                console.error("Error fetching daily briefing:", error);
                dailyBriefingContentArea.innerHTML = `<p style="color: #F44336;">Error: ${error.message}</p>`;
                showNotification(`Error fetching briefing: ${error.message}`, "error");
            }
        }

        function scrollToBottom() {
            if (chatMessagesArea) chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.padding = '10px 16px';
            notification.style.borderRadius = '4px';
            notification.style.color = 'white';
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s ease';
            notification.style.zIndex = '1000';
            if (type === 'success') { notification.style.backgroundColor = '#4CAF50'; }
            else if (type === 'error') { notification.style.backgroundColor = '#F44336'; }
            else { notification.style.backgroundColor = '#F97B65'; }
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.opacity = '1'; }, 10);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function processThinkTagsInMarkdown(markdown) {
            const thinkBlocks = [];
            let blockIdCounter = 0;
            const processedMarkdown = markdown.replace(/<think>([\s\S]*?)<\/think>/g, (match, thinkContent) => {
                const currentId = blockIdCounter++;
                thinkBlocks.push({ id: `think-${Date.now()}-${currentId}`, rawContent: thinkContent });
                return `${THINK_TAG_PLACEHOLDER_PREFIX}${thinkBlocks[thinkBlocks.length - 1].id}${THINK_TAG_PLACEHOLDER_SUFFIX}`;
            });
            return { processedMarkdown, thinkBlocks };
        }

        function renderThinkBlocksHTML(contentDiv, thinkBlocks) {
            if (!contentDiv || !thinkBlocks || thinkBlocks.length === 0) return;
            let html = contentDiv.innerHTML;
            thinkBlocks.forEach(block => {
                const placeholder = `${THINK_TAG_PLACEHOLDER_PREFIX}${block.id}${THINK_TAG_PLACEHOLDER_SUFFIX}`;
                const thinkSectionHtml = `
                        <div class="collapsible-think-section">
                            <div class="think-header" data-think-block-id="${block.id}">
                                <span>AI Thoughts</span> <span class="toggle-icon">[+]</span>
                            </div>
                            <div class="think-content" id="think-content-${block.id}" style="display:none;">
                                ${marked.parse(block.rawContent)}
                            </div>
                        </div>`;
                const placeholderRegExp = new RegExp(RegExp.escape(placeholder), 'g');
                html = html.replace(placeholderRegExp, thinkSectionHtml);
            });
            contentDiv.innerHTML = html;
        }

        function addThinkBlockListeners(parentElement) {
            if (!parentElement) return;
            parentElement.querySelectorAll('.think-header').forEach(header => {
                if (header.dataset.listenerAttached === 'true') return;
                header.addEventListener('click', () => {
                    const blockId = header.dataset.thinkBlockId;
                    const thinkContentElement = parentElement.querySelector(`#think-content-${blockId}`);
                    const toggleIcon = header.querySelector('.toggle-icon');
                    if (thinkContentElement) {
                        const isHidden = thinkContentElement.style.display === 'none';
                        thinkContentElement.style.display = isHidden ? 'block' : 'none';
                        if (toggleIcon) toggleIcon.textContent = isHidden ? '[-]' : '[+]';
                        if (isHidden) {
                            Prism.highlightAllUnder(thinkContentElement);
                            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                                MathJax.typesetPromise([thinkContentElement]).catch(err => console.warn("MathJax (think):", err));
                            }
                        }
                    }
                });
                header.dataset.listenerAttached = 'true';
            });
        }

        function displayMessage(sender, content, metadata = null) {
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble', sender.toLowerCase() + '-message');
            const senderDiv = document.createElement('div');
            senderDiv.classList.add('message-sender');
            senderDiv.textContent = sender === 'User' ? 'You' : 'Pathos';
            messageBubble.appendChild(senderDiv);
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            let textContent = "";
            let imageUrl = null;
            let documentContent = null;
            if (Array.isArray(content)) {
                content.forEach(part => {
                    if (part.type === 'text') {
                        if (part.text && typeof part.text === 'string' && part.text.includes("--- Uploaded Document Content ---")) {
                             const docMatch = part.text.match(/--- Uploaded Document Content ---\n([\s\S]*?)\n--- End Uploaded Document Content ---/);
                             if (docMatch) {
                                  documentContent = docMatch[1].trim();
                                  textContent += part.text.split("--- Uploaded Document Content ---")[0].trim() + " ";
                             } else { textContent += part.text + " "; }
                        } else if (part.text && typeof part.text === 'string') { textContent += part.text; }
                    } else if (part.type === 'image_url' && part.image_url && part.image_url.url) { imageUrl = part.image_url.url; }
                });
            } else if (typeof content === 'string') { textContent = content; }
            else { textContent = String(content); }
            if (documentContent) {
                 const docDisplayDiv = document.createElement('div');
                 docDisplayDiv.classList.add('document-content-display');
                 docDisplayDiv.innerHTML = `<strong>Uploaded Document:</strong><br><pre>${documentContent}</pre>`;
                 contentDiv.appendChild(docDisplayDiv);
            }
            const { processedMarkdown, thinkBlocks } = processThinkTagsInMarkdown(textContent);
            contentDiv.innerHTML += marked.parse(processedMarkdown);
            if (imageUrl) {
                 const imgElement = document.createElement('img');
                 imgElement.src = imageUrl;
                 contentDiv.appendChild(imgElement);
            }
            renderThinkBlocksHTML(contentDiv, thinkBlocks);
            addThinkBlockListeners(contentDiv);
            Prism.highlightAllUnder(contentDiv);
            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                MathJax.typesetPromise([contentDiv]).catch(err => console.warn(`MathJax processing error for ${sender} message:`, err));
            }
            messageBubble.appendChild(contentDiv);
            if (sender === 'AI' && metadata) {
                const footerInfoDiv = document.createElement('div');
                footerInfoDiv.classList.add('message-footer-info');
                let infoParts = [];
                if (metadata.usage) {
                    const usage = metadata.usage;
                    let tokenInfo = `Tokens: `;
                    if (usage.total_tokens !== undefined) tokenInfo += `Total ${usage.total_tokens}`;
                    else if (usage.prompt_tokens !== undefined && usage.completion_tokens !== undefined) tokenInfo += `Prompt ${usage.prompt_tokens}, Completion ${usage.completion_tokens}`;
                    else if (usage.estimated_prompt_tokens !== undefined) tokenInfo += `Est. Prompt ${usage.estimated_prompt_tokens}`;
                    if (tokenInfo !== `Tokens: `) { infoParts.push(`<strong>${tokenInfo}</strong>`); }
                }
                if (metadata.hexus_scores) {
                    const hexus = metadata.hexus_scores;
                    let hexusInfo = `Hexus: `;
                    let hexusScoreParts = [];
                    if (hexus.general_caution !== undefined) hexusScoreParts.push(`C ${hexus.general_caution.toFixed(2)}`);
                    if (hexus.user_engagement_proactivity !== undefined) hexusScoreParts.push(`P ${hexus.user_engagement_proactivity.toFixed(2)}`);
                    if (hexus.brevity_preference !== undefined) hexusScoreParts.push(`B ${hexus.brevity_preference.toFixed(2)}`);
                    if (hexusScoreParts.length > 0) { hexusInfo += hexusScoreParts.join(', '); infoParts.push(`<strong>${hexusInfo}</strong>`); }
                }
                if (metadata.mood_at_response) {
                    const mood = metadata.mood_at_response;
                    let moodInfo = `Mood: `;
                    let moodScoreParts = [];
                    if (mood.valence !== undefined) moodScoreParts.push(`V ${mood.valence.toFixed(2)}`);
                    if (mood.arousal !== undefined) moodScoreParts.push(`A ${mood.arousal.toFixed(2)}`);
                    if (moodScoreParts.length > 0) { moodInfo += moodScoreParts.join(', ')}
                }
                if (infoParts.length > 0) { footerInfoDiv.innerHTML = infoParts.join(' | '); messageBubble.appendChild(footerInfoDiv); }
                 if (metadata.vision_llm_output) {
                     const visionDiv = document.createElement('div');
                     visionDiv.classList.add('vision-analysis');
                     visionDiv.innerHTML = `<strong>Vision Analysis:</strong> ${metadata.vision_llm_output}`;
                     messageBubble.appendChild(visionDiv);
                 }
                setTimeout(() => {
                    const feedbackContainer = document.createElement('div');
                    feedbackContainer.style.textAlign = 'right';
                    feedbackContainer.style.marginTop = '8px';
                    const thumbsUpButton = document.createElement('button');
                    thumbsUpButton.innerHTML = '👍';
                    thumbsUpButton.title = 'This was helpful';
                    Object.assign(thumbsUpButton.style, { background: 'transparent', border: 'none', color: '#888888', fontSize: '16px', cursor: 'pointer', padding: '5px 10px', marginLeft: '5px', borderRadius: '4px' });
                    thumbsUpButton.dataset.feedbackType = 'positive';
                    thumbsUpButton.dataset.rating = '1';
                    const thumbsDownButton = document.createElement('button');
                    thumbsDownButton.innerHTML = '👎';
                    thumbsDownButton.title = 'This was not helpful';
                    Object.assign(thumbsDownButton.style, { background: 'transparent', border: 'none', color: '#888888', fontSize: '16px', cursor: 'pointer', padding: '5px 10px', marginLeft: '5px', borderRadius: '4px' });
                    thumbsDownButton.dataset.feedbackType = 'negative';
                    thumbsDownButton.dataset.rating = '-1';
                    const feedbackTextContainer = document.createElement('div');
                    feedbackTextContainer.classList.add('feedback-text-container');
                    feedbackTextContainer.style.display = 'none';
                    const feedbackTextArea = document.createElement('textarea');
                    feedbackTextArea.placeholder = 'Optional: Tell me why...';
                    feedbackTextArea.rows = 2;
                    const feedbackSubmitButton = document.createElement('button');
                    feedbackSubmitButton.textContent = 'Submit';
                    feedbackTextContainer.appendChild(feedbackTextArea);
                    feedbackTextContainer.appendChild(feedbackSubmitButton);
                    const handleFeedbackClick = function() {
                         const button = this;
                         feedbackSubmitButton.dataset.feedbackType = button.dataset.feedbackType;
                         feedbackSubmitButton.dataset.rating = button.dataset.rating;
                         thumbsUpButton.style.pointerEvents = 'none'; thumbsDownButton.style.pointerEvents = 'none';
                         thumbsUpButton.style.opacity = '0.5'; thumbsDownButton.style.opacity = '0.5';
                         feedbackTextContainer.style.display = ''; feedbackTextArea.focus();
                    };
                    const handleSubmitFeedback = async function() {
                         const submitButton = this;
                         const feedbackType = submitButton.dataset.feedbackType;
                         const rating = parseInt(submitButton.dataset.rating, 10);
                         const feedbackText = feedbackTextArea.value.trim();
                         feedbackTextContainer.style.display = 'none'; feedbackTextArea.value = '';
                         let lastUserInput = "N/A";
                         const prevUserBubble = submitButton.closest('.message-bubble').previousElementSibling;
                         if (prevUserBubble && prevUserBubble.classList.contains('user-message')) {
                              const userContentParts = prevUserBubble.querySelector('.message-content').childNodes;
                              let userText = "";
                              userContentParts.forEach(node => { if (node.nodeType === Node.TEXT_NODE) userText += node.textContent; });
                              lastUserInput = userText.trim();
                         } else if (conversationHistory.length >= 2) {
                              const lastUserHistoryMsg = conversationHistory[conversationHistory.length - 2];
                              if (lastUserHistoryMsg && lastUserHistoryMsg.role === 'user') {
                                  if (typeof lastUserHistoryMsg.content === 'string') lastUserInput = lastUserHistoryMsg.content;
                                  else if (Array.isArray(lastUserHistoryMsg.content)) {
                                       let userText = "";
                                       lastUserHistoryMsg.content.forEach(part => { if (part.type === 'text') userText += part.text; });
                                       lastUserInput = userText.trim();
                                  }
                              }
                         }
                         const aiMessageContent = contentDiv.textContent.trim();
                         const feedbackPayload = { user_id: currentUserId, last_user_input: lastUserInput, last_pathos_response: aiMessageContent, feedback_type: feedbackType, rating: rating, feedback_text: feedbackText || `${feedbackType} feedback from user via GUI (no text)` };
                         try {
                             const response = await fetch(`${EIDOS_API_BASE_URL}/feedback`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-User-Id': currentUserId }, body: JSON.stringify(feedbackPayload) });
                             const originalButton = feedbackContainer.querySelector(`button[data-feedback-type="${feedbackType}"]`);
                             if (response.status === 202) {
                                 if (originalButton) { originalButton.style.color = (feedbackType === 'positive') ? '#4CAF50' : '#F44336'; originalButton.innerHTML = (feedbackType === 'positive') ? '👍 Thanks!' : '👎 Noted.'; }
                                 showNotification(`Feedback (${feedbackType}) submitted successfully.`, "success");
                             } else {
                                  const errorText = await response.text();
                                  if (originalButton) { originalButton.style.color = '#F44336'; originalButton.innerHTML = (feedbackType === 'positive') ? '👍 Failed' : '👎 Failed'; }
                                  showNotification(`Failed to submit feedback (${feedbackType}).`, "error"); console.error("Feedback API Error:", response.status, errorText);
                             }
                         } catch (error) {
                             console.error("Error sending feedback:", error);
                             const originalButton = feedbackContainer.querySelector(`button[data-feedback-type="${feedbackType}"]`);
                             if (originalButton) { originalButton.style.color = '#F44336'; originalButton.innerHTML = (feedbackType === 'positive') ? '👍 Error' : '👎 Error'; }
                             showNotification(`Error sending feedback (${feedbackType}).`, "error");
                         }
                    };
                    thumbsUpButton.addEventListener('click', handleFeedbackClick);
                    thumbsDownButton.addEventListener('click', handleFeedbackClick);
                    feedbackSubmitButton.addEventListener('click', handleSubmitFeedback);
                    feedbackContainer.appendChild(thumbsDownButton);
                    feedbackContainer.appendChild(thumbsUpButton);
                    feedbackContainer.appendChild(feedbackTextContainer);
                    messageBubble.appendChild(feedbackContainer);
                }, 500);
            }
            const timestampDiv = document.createElement('div');
            timestampDiv.classList.add('message-timestamp');
            timestampDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageBubble.appendChild(timestampDiv);
            if (chatMessagesArea) chatMessagesArea.appendChild(messageBubble);
            scrollToBottom();
            return messageBubble;
        }

        function displayProactiveMessage(messageContent, metadata = null) {
             console.log("displayProactiveMessage called with content:", messageContent, "and metadata:", metadata); 
             const itemDiv = document.createElement('div');
             itemDiv.classList.add('proactive-item');
             itemDiv.dataset.rawMessage = messageContent; 
             if (metadata && metadata.proactive_utterance_id) { // Store the ID
                itemDiv.dataset.proactiveId = metadata.proactive_utterance_id;
             }


             const dateDiv = document.createElement('div');
             dateDiv.classList.add('proactive-item-date');
             dateDiv.textContent = new Date().toLocaleString();

             const contentDiv = document.createElement('div');
             const { processedMarkdown, thinkBlocks } = processThinkTagsInMarkdown(messageContent);
             contentDiv.innerHTML = marked.parse(processedMarkdown);
             renderThinkBlocksHTML(contentDiv, thinkBlocks);
             addThinkBlockListeners(contentDiv);

             if (metadata) {
                 const metaDiv = document.createElement('div');
                 metaDiv.style.fontSize = '0.8em'; metaDiv.style.color = '#AAAAAA'; metaDiv.style.marginTop = '5px';
                 let metaParts = [];
                 if (metadata.proactive_type) metaParts.push(`Type: ${metadata.proactive_type}`);
                 if (metadata.mood_at_generation) {
                     const mood = metadata.mood_at_generation; let moodScoreParts = [];
                     if (mood.valence !== undefined) moodScoreParts.push(`V ${mood.valence.toFixed(2)}`);
                     if (mood.arousal !== undefined) moodScoreParts.push(`A ${mood.arousal.toFixed(2)}`);
                     if (moodScoreParts.length > 0) metaParts.push(`Mood: ${moodScoreParts.join(', ')}`);
                 }
                 if (metadata.hexus_at_generation) {
                     const hexus = metadata.hexus_at_generation; let hexusParts = [];
                     if (hexus.general_caution !== undefined) hexusParts.push(`C ${hexus.general_caution.toFixed(2)}`);
                     if (hexus.user_engagement_proactivity !== undefined) hexusParts.push(`P ${hexus.user_engagement_proactivity.toFixed(2)}`);
                     if (hexus.brevity_preference !== undefined) hexusParts.push(`B ${hexus.brevity_preference.toFixed(2)}`);
                     if (hexusParts.length > 0) metaParts.push(`Hexus: ${hexusParts.join(', ')}`);
                 }
                 if (metaParts.length > 0) { metaDiv.innerHTML = metaParts.join(' | '); itemDiv.appendChild(metaDiv); }
             }
             itemDiv.appendChild(dateDiv);
             itemDiv.appendChild(contentDiv);

             itemDiv.addEventListener('click', () => {
                const clickedRawMessage = itemDiv.dataset.rawMessage;
                const proactiveId = itemDiv.dataset.proactiveId;

                if (userInput && clickedRawMessage) {
                    // 1. Display Pathos's proactive message in the main chat area
                    const proactiveDisplayMetadata = {
                        injected_proactive_thought: true,
                        proactive_utterance_id: proactiveId 
                    };
                    displayMessage("AI", clickedRawMessage, proactiveDisplayMetadata); // "AI" or "Pathos"

                    // 2. Add this proactive message to the *local* conversationHistory
                    conversationHistory.push({
                        role: "assistant",
                        content: clickedRawMessage,
                        metadata: { 
                            proactive_utterance_id: proactiveId, 
                            injected_proactive: true // Flag for sendMessage
                        }
                    });

                    // 3. Clear the input field and set focus for the user's reply
                    userInput.value = "";
                    userInput.placeholder = "Your response to Pathos...";
                    userInput.focus();
                    autoAdjustTextareaHeight(userInput);

                    // 4. Remove the clicked proactive thought from the proactive panel
                    itemDiv.remove();
                    const proactiveArea = document.getElementById('proactive-messages-area');
                    if (proactiveArea && proactiveArea.children.length === 0) { // Check if it's truly empty
                        proactiveArea.innerHTML = '<p style="color: #888;">No proactive messages yet.</p>';
                    } else if (proactiveArea && proactiveArea.children.length === 1 && proactiveArea.firstChild.tagName === 'P' && proactiveArea.firstChild.style.color === 'rgb(136, 136, 136)') {
                        // Handles the case where only the placeholder <p> is left
                         proactiveArea.innerHTML = '<p style="color: #888;">No proactive messages yet.</p>';
                    }
                    
                    // 5. Ensure the main chat interface is expanded
                    expandChatInterface();
                    
                    // 6. Clear any temporary "Responding to..." display if it was used previously
                    const tempDisplay = document.querySelector('.proactive-reply-context-display');
                    if (tempDisplay) tempDisplay.remove();

                } else {
                    console.error("Proactive item click: userInput or clickedRawMessage missing, or proactiveId missing.");
                    if (!userInput) console.error("userInput element is null!");
                    if (!clickedRawMessage) console.error("rawMessage from data attribute is null!");
                    if (!proactiveId) console.error("proactiveId from data attribute is null!");
                }
            });


             const placeholder = proactiveMessagesArea.querySelector('p[style*="color: #888;"]');
             if (placeholder) { proactiveMessagesArea.insertBefore(itemDiv, placeholder); }
             else { proactiveMessagesArea.prepend(itemDiv); }
        }

        async function fetchModels() {
            const dynamicLlmUrl = llmProviderUrlInput ? llmProviderUrlInput.value.trim() : localStorage.getItem(LLM_PROVIDER_URL_KEY);
            const modelsApiUrl = dynamicLlmUrl ? `${dynamicLlmUrl.replace(/\/+$/, '')}/models` : `${EIDOS_API_BASE_URL.replace(/\/+$/, '')}/models`;

            console.log(`fetchModels: Attempting to fetch models from: ${modelsApiUrl}`);

            if (!modelsApiUrl) {
                 console.error("fetchModels: Cannot fetch models: No Eidos API URL or LLM Provider URL is set.");
                 if (modelSelect) modelSelect.innerHTML = '<option value="">API URL not set</option>';
                 if (dropdownContent) dropdownContent.innerHTML = '';
                 if (modelDisplayName) modelDisplayName.textContent = 'No Model';
                 return;
            }

            try {
                const response = await fetch(modelsApiUrl);
                if (!response.ok) {
                    if (dynamicLlmUrl && dynamicLlmUrl !== EIDOS_API_BASE_URL) {
                         console.warn(`fetchModels: Failed to fetch models from dynamic URL (${response.status}). Attempting fallback to Eidos API URL.`);
                         const fallbackModelsApiUrl = `${EIDOS_API_BASE_URL.replace(/\/+$/, '')}/models`;
                         const fallbackResponse = await fetch(fallbackModelsApiUrl);
                         if (!fallbackResponse.ok) throw new Error(`HTTP error! status: ${fallbackResponse.status} from fallback URL`);
                         const fallbackData = await fallbackResponse.json();
                         populateModelSelector(fallbackData.data || [], EIDOS_API_BASE_URL);
                         return;
                    }
                    throw new Error(`HTTP error! status: ${response.status} from ${modelsApiUrl}`);
                }
                const data = await response.json();
                populateModelSelector(data.data || [], dynamicLlmUrl || EIDOS_API_BASE_URL);
            } catch (error) {
                console.error("fetchModels: Error fetching models:", error);
                if (modelSelect) modelSelect.innerHTML = '<option value="">Error loading models</option>';
                if (dropdownContent) dropdownContent.innerHTML = '';
                if (modelDisplayName) modelDisplayName.textContent = 'Error';
                populateModelSelector([{id: "eidos-agent"}]); 
            }
        }

        function populateModelSelector(models, urlUsedForFetching = null) {
            if (!modelSelect || !dropdownContent || !modelDisplayName) return;
            modelSelect.innerHTML = ''; dropdownContent.innerHTML = '';

            if (!models || models.length === 0) {
                modelSelect.innerHTML = '<option value="">No models found</option>';
                modelDisplayName.textContent = 'No Model'; return;
            }

            const eidosAgentExists = models.some(model => model.id === "eidos-agent");
            if (!eidosAgentExists) {
                 const eidosOption = document.createElement('option');
                 eidosOption.value = "eidos-agent"; eidosOption.textContent = "eidos-agent";
                 modelSelect.appendChild(eidosOption);
                 const eidosDropdownItem = document.createElement('div');
                 eidosDropdownItem.textContent = "eidos-agent"; eidosDropdownItem.dataset.modelName = "eidos-agent";
                 eidosDropdownItem.dataset.providerUrl = EIDOS_API_BASE_URL;
                 eidosDropdownItem.addEventListener('click', function() { selectModel(this.dataset.modelName, this.dataset.providerUrl); });
                 dropdownContent.appendChild(eidosDropdownItem);
            }

            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id; option.textContent = model.id;
                modelSelect.appendChild(option);
                const dropdownItem = document.createElement('div');
                dropdownItem.textContent = model.id; dropdownItem.dataset.modelName = model.id;
                dropdownItem.dataset.providerUrl = urlUsedForFetching || EIDOS_API_BASE_URL;
                dropdownItem.addEventListener('click', function() { selectModel(this.dataset.modelName, this.dataset.providerUrl); });
                dropdownContent.appendChild(dropdownItem);
            });

            const savedSelectedModel = localStorage.getItem(SELECTED_MODEL_KEY);
            let defaultModelId = eidosAgentExists ? "eidos-agent" : (models.length > 0 ? models[0].id : "");
            let defaultProviderUrl = eidosAgentExists ? EIDOS_API_BASE_URL : (urlUsedForFetching || EIDOS_API_BASE_URL);

            if (savedSelectedModel && models.some(m => m.id === savedSelectedModel)) {
                defaultModelId = savedSelectedModel;
                const savedModelEntry = dropdownContent.querySelector(`div[data-model-name="${savedSelectedModel}"]`);
                if (savedModelEntry && savedModelEntry.dataset.providerUrl) {
                    defaultProviderUrl = savedModelEntry.dataset.providerUrl;
                }
            } else if (savedSelectedModel) {
                console.log(`populateModelSelector: Previously selected model '${savedSelectedModel}' not found. Using default.`);
            }

            selectModel(defaultModelId, defaultProviderUrl); 

            dropdownContent.querySelectorAll('div').forEach(item => {
                item.classList.toggle('selected', item.dataset.modelName === defaultModelId && item.dataset.providerUrl === defaultProviderUrl);
            });
        }

        function selectModel(modelName, providerUrl) {
             if (modelSelect) modelSelect.value = modelName;
             if (modelDisplayName) modelDisplayName.textContent = modelName;
             localStorage.setItem(SELECTED_MODEL_KEY, modelName); 
             console.log(`selectModel: Selected Model: ${modelName}, Provider URL: ${providerUrl}, Saved to localStorage.`);
        }


        async function sendMessage(forceSearchPrefix = "") {
            const rawMessageText = userInput.value.trim();
            const messageText = forceSearchPrefix + rawMessageText;

            const selectedModelFromDropdown = modelSelect.value; 
            const systemPrompt = systemPromptInput.value.trim();
            const attachedImageBase64 = imageInput.dataset.attachedImageBase64;
            const documentTextToSend = attachedDocumentText;
            const currentWeatherLocation = weatherLocationInput ? weatherLocationInput.value.trim() : null;
            const contextLengthOverride = contextLengthInput ? parseInt(contextLengthInput.value, 10) : null;
            const llmProviderUrlOverride = llmProviderUrlInput ? llmProviderUrlInput.value.trim() : null;
            
            if ((!rawMessageText && !forceSearchPrefix) && !attachedImageBase64 && !documentTextToSend || !selectedModelFromDropdown || isAwaitingResponse) { 
                 if ((!rawMessageText && !forceSearchPrefix) && !attachedImageBase64 && !documentTextToSend) showNotification("Please enter a message, attach an image, or upload a document.", "info");
                 return;
            }

            if (messageText || attachedImageBase64 || documentTextToSend) { expandChatInterface(); }
            isAwaitingResponse = true;
            if (sendButton) sendButton.disabled = true; if (userInput) userInput.disabled = true;
            if (uploadDocumentButton) uploadDocumentButton.disabled = true; if (uploadImageButton) uploadImageButton.disabled = true;
            if (resetChatButton) resetChatButton.disabled = true; if (removeAttachedDocumentButton) removeAttachedDocumentButton.disabled = true;
            if (forceWebSearchButton) forceWebSearchButton.disabled = true;
            if (microphoneButton) microphoneButton.disabled = true; 

            const userMessageContent = [];
            if (messageText) { userMessageContent.push({ type: "text", text: messageText }); }
            if (attachedImageBase64) { userMessageContent.push({ type: "image_url", image_url: { url: `data:image/jpeg;base64,${attachedImageBase64}` } }); }
            if (documentTextToSend) {
                 const formattedDocumentContent = `--- Uploaded Document Content ---\n${documentTextToSend}\n--- End Uploaded Document Content ---`;
                 userMessageContent.push({ type: "text", text: formattedDocumentContent });
            }
            if (messageText || attachedImageBase64 || documentTextToSend) { displayMessage("User", userMessageContent); }
            userInput.value = '';
            autoAdjustTextareaHeight(userInput); 
            if (imageInput) imageInput.dataset.attachedImageBase64 = '';
            attachedDocumentText = null; attachedDocumentName = null; hideAttachedDocumentIndicator();
            const messagesForApi = [];
            if (systemPrompt) { messagesForApi.push({ role: "system", content: systemPrompt }); }
            messagesForApi.push(...conversationHistory);
            messagesForApi.push({ role: "user", content: userMessageContent });
            const tempAiMessageBubble = displayMessage("AI", "Processing...");

            try {
                const requestBodyMetadata = { weather_location: currentWeatherLocation };

                if (llmProviderUrlOverride && llmProviderUrlOverride.startsWith('http')) {
                    requestBodyMetadata.llm_provider_url_override = llmProviderUrlOverride;
                }
                if (contextLengthOverride && !isNaN(contextLengthOverride) && contextLengthOverride > 0) {
                    requestBodyMetadata.max_tokens_override = contextLengthOverride;
                }
                if (selectedModelFromDropdown) {
                    requestBodyMetadata.pathos_model_override = selectedModelFromDropdown;
                }
                if (conversationHistory.length >= 2) {
                    const secondLastMessage = conversationHistory[conversationHistory.length - 2]; 
                    const lastMessage = conversationHistory[conversationHistory.length - 1]; 
                    if (secondLastMessage.role === 'assistant' && 
                        secondLastMessage.metadata && 
                        secondLastMessage.metadata.injected_proactive === true &&
                        secondLastMessage.metadata.proactive_utterance_id &&
                        lastMessage.role === 'user') { // Ensure the last message is indeed the user's reply
                        
                        requestBodyMetadata.engaged_proactive_id = secondLastMessage.metadata.proactive_utterance_id;
                        // Clean up the temporary flag from local history after use
                        delete secondLastMessage.metadata.injected_proactive; 
                        console.log("sendMessage: Detected reply to injected proactive message. Sending engaged_proactive_id:", requestBodyMetadata.engaged_proactive_id);
                    }
                }


                const requestBody = {
                    model: selectedModelFromDropdown, 
                    messages: messagesForApi,
                    temperature: parseFloat(modelTemperatureInput.value),
                    stream: false,
                    user: currentUserId,
                    metadata: requestBodyMetadata
                };

                const apiKey = localStorage.getItem(EIDOS_API_KEY_KEY);
                const headers = { 'Content-Type': 'application/json', 'X-User-Id': currentUserId };
                if (apiKey) { headers['X-API-Key'] = apiKey; }

                const response = await fetch(`${EIDOS_API_BASE_URL}/chat/completions`, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
                const result = await response.json();
                console.log("Eidos API Response:", result);
                let aiResponseContent = "[Error: No content received from AI]";
                let responseMetadata = null; let responseUsage = result.usage;
                if (result.choices && result.choices.length > 0 && result.choices[0].message) {
                     const message = result.choices[0].message; responseMetadata = message.metadata;
                     if (message.content) { aiResponseContent = message.content; }
                     else if (message.tool_calls) { aiResponseContent = "[AI requested tool execution. Please check logs for tool results or send a new message.]"; }
                     if (tempAiMessageBubble) tempAiMessageBubble.remove();
                     const messageDisplayMetadata = { usage: responseUsage, hexus_scores: responseMetadata?.hexus_scores, vision_llm_output: responseMetadata?.vision_llm_output, mood_at_response: responseMetadata?.mood_at_response };
                     displayMessage("AI", aiResponseContent, messageDisplayMetadata);
                     // User message already added to conversationHistory before this call
                     conversationHistory.push({ role: "assistant", content: aiResponseContent });
                } else {
                     if (tempAiMessageBubble) tempAiMessageBubble.remove();
                     aiResponseContent = "[Error: Unexpected response structure from Eidos]";
                     displayMessage("AI", aiResponseContent, { usage: responseUsage });
                     // User message already added
                }

            } catch (error) {
                if (tempAiMessageBubble) tempAiMessageBubble.remove();
                console.error("Error sending message to Eidos:", error);
                const errorMessage = `**Error:** ${error.message || "An unknown error occurred during API call."}`;
                displayMessage("AI", errorMessage, { usage: null });
                // User message already added
            } finally {
                isAwaitingResponse = false;
                // ... (enable buttons) ...
                if (sendButton) sendButton.disabled = false; if (userInput) userInput.disabled = false;
                if (uploadDocumentButton) uploadDocumentButton.disabled = false; if (uploadImageButton) uploadImageButton.disabled = false;
                if (resetChatButton) resetChatButton.disabled = false; if (removeAttachedDocumentButton) removeAttachedDocumentButton.disabled = false;
                if (forceWebSearchButton) forceWebSearchButton.disabled = false;
                if (microphoneButton) microphoneButton.disabled = false; 

                // Clear any temporary "Responding to..." display
                const tempDisplay = document.querySelector('.proactive-reply-context-display');
                if (tempDisplay) tempDisplay.remove();
                userInput.placeholder = "How can I help you today?"; // Reset placeholder
                
                if (userInput) userInput.focus(); 
                scrollToBottom();
            }
        }

        async function handleDocumentUpload(file) {
            const maxSizeInMB = 50; const maxSizeInBytes = maxSizeInMB * 1024 * 1024;
            if (file.size > maxSizeInBytes) { showNotification(`File is too large. Maximum size is ${maxSizeInMB}MB`, 'error'); if (documentInput) documentInput.value = ''; return; }
            const formData = new FormData(); formData.append('file', file);
            showNotification(`Uploading document "${file.name}" to Eidos...`);
            try {
                const response = await fetch(`${EIDOS_API_BASE_URL}/documents/upload`, { method: 'POST', headers: { 'X-User-Id': currentUserId }, body: formData });
                const result = await response.json();
                if (response.ok && result.success && result.extracted_text) {
                    attachedDocumentText = result.extracted_text; attachedDocumentName = file.name;
                    showAttachedDocumentIndicator(file.name);
                    showNotification(`Document "${file.name}" processed. Text attached to your next message.`, 'success');
                } else {
                     const errorMsg = result.message || `Failed to process document ${file.name}.`;
                     showNotification(`Upload failed for "${file.name}": ${errorMsg}`, 'error'); console.error("Eidos Document Upload Error:", response.status, result);
                }
            } catch (error) { console.error("Error uploading document to Eidos:", error); showNotification(`Error uploading "${file.name}": ${error.message}`, 'error');
            } finally { if (documentInput) documentInput.value = ''; }
        }
        function handleImageUpload(file) {
             const reader = new FileReader();
             reader.onload = function(e) {
                 const base64String = e.target.result.split(',')[1]; const fileName = file.name;
                 if (imageInput) imageInput.dataset.attachedImageBase64 = base64String;
                 showNotification(`Image "${fileName}" attached to next message.`, 'info');
             };
             reader.onerror = function() { showNotification('Error reading the image file', 'error'); };
             reader.readAsDataURL(file);
        }
        function showAttachedDocumentIndicator(fileName) {
             if (attachedDocumentIndicator && attachedDocumentNameSpan) { attachedDocumentNameSpan.textContent = fileName; attachedDocumentIndicator.style.display = 'flex'; }
        }
        function hideAttachedDocumentIndicator() {
             if (attachedDocumentIndicator && attachedDocumentNameSpan) { attachedDocumentNameSpan.textContent = ''; attachedDocumentIndicator.style.display = 'none'; }
        }
        function removeAttachedDocument() {
             attachedDocumentText = null; attachedDocumentName = null; hideAttachedDocumentIndicator(); showNotification('Attached document removed.', 'info');
        }

        function saveChatToHistory() {
            if (conversationHistory.length === 0) {
                console.log("No conversation to save.");
                return;
            }
            const currentSystemPrompt = systemPromptInput.value.trim();
            const chatEntry = {
                timestamp: new Date().toISOString(),
                systemPrompt: currentSystemPrompt,
                conversation: [...conversationHistory],
                title: conversationHistory.find(msg => msg.role === 'user')?.content.substring(0, 50) || "Chat"
            };
            let savedHistories = JSON.parse(localStorage.getItem(CHAT_HISTORY_KEY)) || [];
            savedHistories.unshift(chatEntry);
            const maxHistoryItems = 50;
            if (savedHistories.length > maxHistoryItems) { savedHistories = savedHistories.slice(0, maxHistoryItems); }
            localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(savedHistories));
            console.log("Chat saved to history:", chatEntry);
        }
        function loadHistoryFromStorage() { return JSON.parse(localStorage.getItem(CHAT_HISTORY_KEY)) || []; }
        function renderHistoryPanel() {
            if (!historyContentArea) { console.error("History content area element not found."); return; }
            const histories = loadHistoryFromStorage(); historyContentArea.innerHTML = '';
            if (histories.length === 0) { historyContentArea.innerHTML = '<p style="color: #888;">No history yet. Chats are saved when you start a new chat.</p>'; return; }
            histories.forEach((entry, index) => {
                const itemDiv = document.createElement('div'); itemDiv.classList.add('history-item'); itemDiv.dataset.historyIndex = index;
                const dateDiv = document.createElement('div'); dateDiv.classList.add('history-item-date'); dateDiv.textContent = new Date(entry.timestamp).toLocaleString();
                const titleDiv = document.createElement('div');
                const firstUserMsg = entry.conversation.find(msg => msg.role === 'user');
                titleDiv.textContent = entry.title || (firstUserMsg ? (typeof firstUserMsg.content === 'string' ? firstUserMsg.content.substring(0, 50) + '...' : 'Multimodal Input...') : 'Empty Chat');
                itemDiv.appendChild(dateDiv); itemDiv.appendChild(titleDiv);
                itemDiv.addEventListener('click', () => { loadChatFromHistory(entry); if (historyPanel) historyPanel.classList.remove('open'); });
                historyContentArea.appendChild(itemDiv);
            });
        }
        function loadChatFromHistory(historyEntry) {
            console.log("Loading chat from history:", historyEntry);
            saveChatToHistory();
            if (chatMessagesArea) chatMessagesArea.innerHTML = ''; conversationHistory = [];
            if (imageInput) imageInput.dataset.attachedImageBase64 = ''; attachedDocumentText = null; attachedDocumentName = null; hideAttachedDocumentIndicator();
            isAwaitingResponse = false;
            if (sendButton) sendButton.disabled = false; if (userInput) userInput.disabled = false;
            if (uploadDocumentButton) uploadDocumentButton.disabled = false; if (uploadImageButton) uploadImageButton.disabled = false;
            if (resetChatButton) resetChatButton.disabled = false; if (removeAttachedDocumentButton) removeAttachedDocumentButton.disabled = false;
            if (forceWebSearchButton) forceWebSearchButton.disabled = false; 
            if (microphoneButton) microphoneButton.disabled = false; 
            if (systemPromptInput) systemPromptInput.value = historyEntry.systemPrompt || "";
            conversationHistory = [...historyEntry.conversation];
            conversationHistory.forEach(message => { displayMessage(message.role === 'user' ? 'User' : 'AI', message.content); });
            expandChatInterface(); if (userInput) { userInput.focus(); autoAdjustTextareaHeight(userInput); } scrollToBottom();
        }
        function resetChat() {
            saveChatToHistory();
            if (chatMessagesArea) chatMessagesArea.innerHTML = ''; conversationHistory = [];
            if (imageInput) imageInput.dataset.attachedImageBase64 = ''; attachedDocumentText = null; attachedDocumentName = null; hideAttachedDocumentIndicator();
            initCleanInterface(); if (userInput) { userInput.focus(); autoAdjustTextareaHeight(userInput); }
            if (proactiveMessagesArea) proactiveMessagesArea.innerHTML = '<p style="color: #888;">No proactive messages yet.</p>';
        }
        function clearAllLocalChatHistory() {
            if (confirm("Are you sure you want to clear all LOCAL chat history? This only affects your browser's saved chats.")) {
                localStorage.removeItem(CHAT_HISTORY_KEY); renderHistoryPanel(); console.log("All local chat history cleared."); showNotification("All local chat history cleared.", "info");
            }
        }

        async function clearUserBackendMemory() {
            if (!currentUserId) {
                showNotification("User ID not set. Cannot clear user memory.", "error");
                return;
            }
            if (confirm(`Are you sure you want to clear ALL Eidos backend memory for your user ID (${currentUserId})? This cannot be undone.`)) {
                showNotification("Requesting Eidos backend to clear memory for your user...");
                try {
                    const response = await fetch(`${EIDOS_API_BASE_URL}/memory/clear_user`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Id': currentUserId
                        },
                        body: JSON.stringify({ user_id: currentUserId })
                    });
                    if (response.ok) {
                        showNotification(`Eidos backend memory for user ${currentUserId} cleared successfully.`, "success");
                        console.log(`Eidos backend memory for user ${currentUserId} cleared via API.`);
                        clearAllLocalChatHistory(); 
                        resetChat(); 
                    } else {
                        const errorText = await response.text();
                        showNotification(`Failed to clear Eidos backend memory for your user: ${response.status}`, 'error');
                        console.error("User Backend Memory Clear API Error:", response.status, errorText);
                    }
                } catch (error) {
                    console.error("Error calling user backend memory clear API:", error);
                    showNotification(`Error clearing Eidos backend memory for your user: ${error.message}`, 'error');
                }
            }
        }


        async function clearEidosBackendMemory() {
            const adminPassword = prompt("Enter Admin Password to clear ALL Eidos backend memory:");
            if (adminPassword === null) { 
                showNotification("Clear Eidos Memory operation cancelled.", "info");
                return;
            }
            if (!adminPassword) {
                showNotification("Admin password cannot be empty.", "warning");
                return;
            }

            if (confirm("Are you sure you want to clear ALL Eidos backend memory? This includes facts, documents, and interaction history for ALL users. This cannot be undone.")) {
                 showNotification("Requesting Eidos backend to clear memory...");
                 try {
                     const response = await fetch(`${EIDOS_API_BASE_URL}/memory/clear`, { 
                         method: 'POST', 
                         headers: { 
                             'X-User-Id': currentUserId,
                             'X-Admin-Password': adminPassword 
                            } 
                        });
                     if (response.ok) {
                         showNotification("Eidos backend memory cleared successfully.", "success"); console.log("Eidos backend memory cleared via API.");
                         clearAllLocalChatHistory();
                         if (chatMessagesArea) chatMessagesArea.innerHTML = ''; conversationHistory = [];
                         if (imageInput) imageInput.dataset.attachedImageBase64 = ''; attachedDocumentText = null; attachedDocumentName = null; hideAttachedDocumentIndicator();
                         initCleanInterface();
                     } else { 
                         const errorText = await response.text(); 
                         let detailMessage = `Failed to clear Eidos backend memory: ${response.status}`;
                         if (response.status === 401 || response.status === 403) {
                             detailMessage = "Authorization failed. Incorrect admin password or password not set on backend.";
                         } else {
                             try {
                                 const errorJson = JSON.parse(errorText);
                                 detailMessage = errorJson.detail || detailMessage;
                             } catch (e) { /* Keep original detailMessage */ }
                         }
                         showNotification(detailMessage, 'error'); 
                         console.error("Backend Memory Clear API Error:", response.status, errorText); 
                        }
                 } catch (error) { 
                     console.error("Error calling backend memory clear API:", error); 
                     showNotification(`Error clearing Eidos backend memory: ${error.message}`, 'error'); 
                    }
             }
        }

        function initCleanInterface() {
            const chatMessagesArea = document.getElementById('chat-messages-area'); const chatContainer = document.querySelector('.chat-container');
            if (chatMessagesArea) { chatMessagesArea.classList.add('minimized'); }
            if (chatContainer) { chatContainer.classList.add('minimized'); chatContainer.classList.remove('chat-active'); }
        }
        function expandChatInterface() {
            const chatContainer = document.querySelector('.chat-container'); const chatMessagesArea = document.getElementById('chat-messages-area');
            if (chatContainer && chatContainer.classList.contains('minimized')) { chatContainer.classList.remove('minimized'); }
            if (chatMessagesArea && chatMessagesArea.classList.contains('minimized')) {
                chatMessagesArea.classList.remove('minimized');
                if (chatContainer) { chatContainer.classList.add('chat-active'); }
                setTimeout(() => { scrollToBottom(); }, 500);
            }
            // Close all panels when chat expands due to new message
            [systemPromptPanel, historyPanel, proactivePanel, dailyBriefingPanel, learningLogPanel, dreamJournalPanel, knowledgeLogPanel].forEach(p => p?.classList.remove('open'));
        }

        async function fetchWeather(location) {
            if (!location || !location.trim()) { console.debug("No weather location set, skipping fetch."); if (weatherPanel) weatherPanel.style.display = 'none'; return; }
            if (weatherUpdateButton) {
                 weatherUpdateButton.addEventListener('click', () => {
                     const location = localStorage.getItem(WEATHER_LOCATION_KEY);
                     if (location && location.trim()) {
                         showNotification('Refreshing weather...', 'info');
                         fetchWeather(location); 
                     }
                     else { 
                         showNotification('Please set a weather location in Settings to refresh.', 'info'); 
                     }
                 });
            }
            if (!EIDOS_API_BASE_URL) { console.error("Eidos API Base URL is not set, cannot fetch weather."); showNotification("Eidos API Base URL is not set in Settings.", "error"); return; }
            let baseUrl = EIDOS_API_BASE_URL; if (baseUrl.endsWith('/v1')) { baseUrl = baseUrl.substring(0, baseUrl.length - 3); }
            const weatherApiUrl = `${baseUrl}/v1/weather?location=${encodeURIComponent(location.trim())}`;
            console.log(`Fetching weather for "${location}" from: ${weatherApiUrl}`);
            if (weatherPanel) {
                 weatherPanel.style.display = 'flex'; if (weatherLocationDisplay) weatherLocationDisplay.textContent = `${location}...`;
                 if (weatherDescriptionDisplay) weatherDescriptionDisplay.textContent = 'Loading...'; if (weatherTemperatureDisplay) weatherTemperatureDisplay.textContent = '--';
                 if (weatherHumidityDisplay) weatherHumidityDisplay.textContent = ''; if (weatherWindDisplay) weatherWindDisplay.textContent = '';
                 if (weatherLastUpdatedDisplay) weatherLastUpdatedDisplay.textContent = '';
            }
            try {
                const response = await fetch(weatherApiUrl, { method: 'GET', headers: { 'X-User-Id': currentUserId } });
                const result = await response.json(); console.log("Weather API Response:", result);
                if (response.ok && result.success && result.weather_data) {
                    const weatherData = result.weather_data; if (weatherPanel) weatherPanel.style.display = 'flex';
                    if (weatherLocationDisplay) weatherLocationDisplay.textContent = weatherData.location || location;
                    if (weatherDescriptionDisplay) weatherDescriptionDisplay.textContent = weatherData.description || 'N/A';
                    if (weatherTemperatureDisplay) { let tempText = '--'; if (weatherData.temperature !== undefined && weatherData.temperature !== null) { tempText = `${weatherData.temperature}°`; if (weatherData.unit) tempText += weatherData.unit; } else if (weatherData.temperature_celsius !== undefined && weatherData.temperature_celsius !== null) { tempText = `${weatherData.temperature_celsius}°C`; } weatherTemperatureDisplay.textContent = tempText; }
                    if (weatherHumidityDisplay) { weatherHumidityDisplay.textContent = weatherData.humidity ? `Humidity: ${weatherData.humidity}` : ''; }
                    if (weatherWindDisplay) { weatherWindDisplay.textContent = weatherData.wind_speed ? `Wind: ${weatherData.wind_speed}` : ''; }
                    if (weatherLastUpdatedDisplay) { weatherLastUpdatedDisplay.textContent = `Updated: ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`; }
                    console.log(`Weather updated for ${location}.`);
                } else { const errorMsg = result.message || result.error || `Failed to fetch weather for ${location}.`; console.error("Weather API Error:", response.status, result); if (weatherPanel) { weatherPanel.style.display = 'flex'; if (weatherLocationDisplay) weatherLocationDisplay.textContent = location; if (weatherDescriptionDisplay) weatherDescriptionDisplay.textContent = `Error: ${errorMsg}`; if (weatherTemperatureDisplay) weatherTemperatureDisplay.textContent = '--'; if (weatherHumidityDisplay) weatherHumidityDisplay.textContent = ''; if (weatherWindDisplay) weatherWindDisplay.textContent = ''; if (weatherLastUpdatedDisplay) weatherLastUpdatedDisplay.textContent = ''; } showNotification(`Failed to fetch weather: ${errorMsg}`, 'error'); }
            } catch (error) { console.error(`Error fetching weather for ${location}:`, error); if (weatherPanel) { weatherPanel.style.display = 'flex'; if (weatherLocationDisplay) weatherLocationDisplay.textContent = location; if (weatherDescriptionDisplay) weatherDescriptionDisplay.textContent = `Connection Error: ${error.message || 'Unknown'}`; if (weatherTemperatureDisplay) weatherTemperatureDisplay.textContent = '--'; if (weatherHumidityDisplay) weatherHumidityDisplay.textContent = ''; if (weatherWindDisplay) weatherWindDisplay.textContent = ''; if (weatherLastUpdatedDisplay) weatherLastUpdatedDisplay.textContent = ''; } showNotification(`Error fetching weather: ${error.message || 'Unknown'}`, 'error'); }
        }
        function setupWeatherUpdates() {
             if (weatherUpdateInterval !== null) { clearInterval(weatherUpdateInterval); weatherUpdateInterval = null; console.log("Cleared existing weather update interval."); }
             const location = localStorage.getItem(WEATHER_LOCATION_KEY);
             if (location && location.trim()) { fetchWeather(location); console.log(`Initial weather fetch triggered for "${location}".`); }
             else { console.log("No weather location set, weather panel is hidden."); if (weatherPanel) weatherPanel.style.display = 'none'; }
        }

        function connectWebSocket() {
            let baseUrl = EIDOS_API_BASE_URL; if (baseUrl.endsWith('/v1')) { baseUrl = baseUrl.substring(0, baseUrl.length - 3); }
            const wsScheme = baseUrl.startsWith('https') ? 'wss' : 'ws'; const hostPort = baseUrl.substring(baseUrl.indexOf('://') + 3);
            const wsUrl = `${wsScheme}://${hostPort}/ws`; console.log(`Attempting WebSocket connection to: ${wsUrl}`);
            if (eidosWebSocket && eidosWebSocket.readyState !== WebSocket.CLOSED && eidosWebSocket.readyState !== WebSocket.CLOSING) { console.log("Closing existing WebSocket connection."); eidosWebSocket.close(); }
            try {
                 const newWebSocket = new WebSocket(wsUrl);
                 newWebSocket.onopen = function(event) { console.log("WebSocket connection opened:", event); const ws = event.target; if (currentUserId) { ws.send(JSON.stringify({ type: "auth", payload: { userId: currentUserId } })); console.log("Sent user ID over WebSocket:", currentUserId); } else { console.warn("WebSocket opened but currentUserId is not set."); } };
                 newWebSocket.onmessage = function(event) { 
                    console.log("WebSocket message received:", event.data); 
                    try { 
                        const message = JSON.parse(event.data); 
                        if (message.type === "unsolicited_message") { 
                            if (message.payload && message.payload.content) {
                                console.log("Received unsolicited_message of proactive_type:", message.payload.metadata?.proactive_type); 
                                displayProactiveMessage(message.payload.content, message.payload.metadata); 
                                showNotification("New proactive message received!", "info"); 
                            } 
                        } else if (message.type === "status") { 
                            if (message.payload && message.payload.message) { console.log("Eidos Status:", message.payload.message); } 
                        } else if (message.type === "error") { 
                            if (message.payload && message.payload.message) { console.error("Eidos WebSocket Error:", message.payload.message); showNotification(`Eidos Error: ${message.payload.message}`, "error"); } 
                        } 
                    } catch (e) { console.error("Failed to parse WebSocket message:", e, event.data); } 
                };
                 newWebSocket.onclose = function(event) { console.log("WebSocket connection closed:", event); if (eidosWebSocket === event.target) { eidosWebSocket = null; } if (event.code !== 1000) { console.log(`WebSocket closed unexpectedly (code: ${event.code}). Attempting to reconnect...`); setTimeout(connectWebSocket, 5000); } else { console.log("WebSocket closed cleanly."); } };
                 newWebSocket.onerror = function(event) { console.error("WebSocket error:", event); };
                 eidosWebSocket = newWebSocket;
            } catch (e) { console.error("WebSocket connection attempt failed:", e); eidosWebSocket = null; setTimeout(connectWebSocket, 10000); }
        }

        function initializeSpeechRecognition() {
            const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognitionAPI) {
                console.warn("Web Speech API not supported by this browser.");
                if (microphoneButton) {
                    microphoneButton.disabled = true;
                    microphoneButton.title = "Voice input not supported by this browser";
                }
                return null;
            }
            const recognition = new SpeechRecognitionAPI();
            recognition.continuous = false; 
            recognition.interimResults = true; 
            recognition.lang = 'en-US'; 

            recognition.onstart = () => {
                isListening = true;
                if (microphoneButton) microphoneButton.classList.add('listening');
                console.log("Speech recognition started.");
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                if (userInput && finalTranscript) { 
                    userInput.value += (userInput.value.length > 0 && !userInput.value.endsWith(' ') ? ' ' : '') + finalTranscript.trim();
                    userInput.focus();
                    autoAdjustTextareaHeight(userInput); 
                }
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                if (event.error === 'no-speech') {
                    showNotification('No speech detected. Please try again.', 'info');
                } else if (event.error === 'audio-capture') {
                    showNotification('Microphone problem. Please check your microphone.', 'error');
                } else if (event.error === 'not-allowed') {
                    showNotification('Microphone access denied. Please allow microphone access in browser settings.', 'error');
                } else {
                    showNotification(`Speech recognition error: ${event.error}`, 'error');
                }
                stopListening(); 
            };

            recognition.onend = () => {
                stopListening();
                console.log("Speech recognition ended.");
            };
            return recognition;
        }

        function toggleListening() {
            if (!speechRecognition) {
                showNotification("Voice input is not available in this browser.", "warning");
                return;
            }
            if (isAwaitingResponse) return; 

            if (isListening) {
                speechRecognition.stop();
            } else {
                try {
                    speechRecognition.start();
                } catch (e) {
                    console.error("Error starting speech recognition:", e);
                    showNotification("Could not start voice input. Please try again.", "error");
                    stopListening(); 
                }
            }
        }

        function stopListening() {
            isListening = false;
            if (microphoneButton) microphoneButton.classList.remove('listening');
            if (speechRecognition && typeof speechRecognition.abort === 'function') { 
                 try { speechRecognition.abort(); } catch(e) { console.warn("Error aborting speech recognition:", e); }
            }
        }
        
        function autoAdjustTextareaHeight(textareaElement) {
            if (!textareaElement) return;
            textareaElement.style.height = 'auto'; 
            let scrollHeight = textareaElement.scrollHeight;
            const maxHeight = parseInt(window.getComputedStyle(textareaElement).maxHeight, 10);
            
            if (scrollHeight > maxHeight) {
                textareaElement.style.height = maxHeight + 'px';
                textareaElement.style.overflowY = 'auto'; 
            } else {
                textareaElement.style.height = scrollHeight + 'px';
                textareaElement.style.overflowY = 'hidden'; 
            }
        }

        async function fetchAndDisplayLearnings() {
            if (!learningLogContentArea) return;
            learningLogContentArea.innerHTML = '<p style="color: #BBBBBB;">Fetching agent learnings...</p>';
            if (!EIDOS_API_BASE_URL) {
                 showNotification("Eidos API Base URL is not set in Settings.", "error");
                 learningLogContentArea.innerHTML = '<p style="color: #F44336;">API URL not set.</p>';
                 return;
            }
            try {
                const response = await fetch(`${EIDOS_API_BASE_URL}/agent/learnings?limit=20`, { 
                    method: 'GET',
                    headers: { 'X-User-Id': currentUserId } 
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch learnings: ${response.status} ${errorText}`);
                }
                const learnings = await response.json();
                learningLogContentArea.innerHTML = ''; 
                if (learnings && learnings.length > 0) {
                    learnings.forEach(learning => {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('history-item'); 
                        
                        const dateDiv = document.createElement('div');
                        dateDiv.classList.add('history-item-date');
                        dateDiv.textContent = `Learned: ${new Date(learning.timestamp).toLocaleString()}`;
                        itemDiv.appendChild(dateDiv);

                        const typeDiv = document.createElement('div');
                        typeDiv.style.fontWeight = 'bold';
                        typeDiv.style.color = '#F97B65'; 
                        typeDiv.textContent = `Type: ${learning.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
                        itemDiv.appendChild(typeDiv);

                        const contentDiv = document.createElement('div');
                        contentDiv.style.marginTop = '5px';
                        contentDiv.innerHTML = marked.parse(learning.content || "[No content]"); 
                        itemDiv.appendChild(contentDiv);

                        if (learning.metadata) {
                            const metaDiv = document.createElement('div');
                            metaDiv.style.fontSize = '0.8em';
                            metaDiv.style.color = '#AAAAAA';
                            metaDiv.style.marginTop = '8px';
                            metaDiv.style.borderTop = '1px dashed #444';
                            metaDiv.style.paddingTop = '5px';
                            
                            let metaText = "";
                            if (learning.metadata.source_feedback_id) {
                                metaText += `Source Feedback ID: ${learning.metadata.source_feedback_id.substring(0,8)}...<br>`;
                            }
                            if (learning.metadata.original_user_input) {
                                metaText += `Original Input: "${learning.metadata.original_user_input.substring(0, 50)}..."<br>`;
                            }
                             if (learning.metadata.user_suggestion_or_feedback_text) {
                                metaText += `User's Text: "${learning.metadata.user_suggestion_or_feedback_text.substring(0, 70)}..."<br>`;
                            }
                            if (metaText) {
                                metaDiv.innerHTML = metaText;
                                itemDiv.appendChild(metaDiv);
                            }
                        }
                        learningLogContentArea.appendChild(itemDiv);
                    });
                } else {
                    learningLogContentArea.innerHTML = '<p style="color: #888;">No recent agent learnings found.</p>';
                }
            } catch (error) {
                console.error("Error fetching agent learnings:", error);
                learningLogContentArea.innerHTML = `<p style="color: #F44336;">Error: ${error.message}</p>`;
                showNotification(`Error fetching agent learnings: ${error.message}`, "error");
            }
        }

        async function fetchAndDisplayDreams() {
            if (!dreamJournalContentArea) return;
            dreamJournalContentArea.innerHTML = '<p style="color: #BBBBBB;">Fetching dreams...</p>';
            if (!EIDOS_API_BASE_URL) {
                 showNotification("Eidos API Base URL is not set in Settings.", "error");
                 dreamJournalContentArea.innerHTML = '<p style="color: #F44336;">API URL not set.</p>';
                 return;
            }
            try {
                const response = await fetch(`${EIDOS_API_BASE_URL}/agent/dreams?limit=15`, { 
                    method: 'GET',
                    headers: { 'X-User-Id': currentUserId } 
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch dreams: ${response.status} ${errorText}`);
                }
                const dreams = await response.json();
                dreamJournalContentArea.innerHTML = ''; 
                if (dreams && dreams.length > 0) {
                    dreams.forEach(dream => {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('dream-journal-item'); 
                        
                        const dateDiv = document.createElement('div');
                        dateDiv.classList.add('dream-timestamp');
                        dateDiv.textContent = `Dreamed: ${new Date(dream.timestamp).toLocaleString()}`;
                        itemDiv.appendChild(dateDiv);

                        const contentDiv = document.createElement('div');
                        contentDiv.classList.add('dream-content');
                        contentDiv.innerHTML = marked.parse(dream.content || "[No textual dream content]"); 
                        itemDiv.appendChild(contentDiv);

                        if (dream.dream_image_url) {
                            const imgContainer = document.createElement('div');
                            imgContainer.classList.add('dream-image-container');
                            const imgElement = document.createElement('img');
                            imgElement.src = dream.dream_image_url; 
                            imgElement.alt = "Dream visualization";
                            imgElement.onerror = () => { 
                                imgElement.alt = "Error loading dream image."; 
                                console.warn("Failed to load dream image:", dream.dream_image_url);
                            };
                            imgContainer.appendChild(imgElement);
                            itemDiv.appendChild(imgContainer);
                        }

                        if (dream.dream_seed_summary) {
                            const seedDiv = document.createElement('div');
                            seedDiv.classList.add('dream-seed-summary');
                            seedDiv.innerHTML = `<strong>Inspired by:</strong> ${dream.dream_seed_summary}`;
                            itemDiv.appendChild(seedDiv);
                        }
                        dreamJournalContentArea.appendChild(itemDiv);
                    });
                } else {
                    dreamJournalContentArea.innerHTML = '<p style="color: #888;">No recent dreams found in the journal.</p>';
                }
            } catch (error) {
                console.error("Error fetching dreams:", error);
                dreamJournalContentArea.innerHTML = `<p style="color: #F44336;">Error fetching dreams: ${error.message}</p>`;
                showNotification(`Error fetching dreams: ${error.message}`, "error");
            }
        }

        async function fetchAndDisplayKnowledgeVerifications() {
            if (!knowledgeLogContentArea) {
                console.error("Knowledge log content area not found in DOM.");
                return;
            }
            knowledgeLogContentArea.innerHTML = '<p style="color: #BBBBBB;">Fetching knowledge upkeep log...</p>';
            
            if (!EIDOS_API_BASE_URL) {
                 showNotification("Eidos API Base URL is not set in Settings.", "error");
                 knowledgeLogContentArea.innerHTML = '<p style="color: #F44336;">API URL not set. Please configure it in Settings.</p>';
                 return;
            }

            try {
                const limit = 25; // Or make this configurable if needed
                const response = await fetch(`${EIDOS_API_BASE_URL}/agent/knowledge_verifications?limit=${limit}`, { 
                    method: 'GET',
                    headers: { 'X-User-Id': currentUserId } 
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let detail = errorText;
                    try { detail = JSON.parse(errorText).detail || errorText; } catch (e) {}
                    throw new Error(`Failed to fetch knowledge verifications: ${response.status} - ${detail}`);
                }

                const verifications = await response.json();
                knowledgeLogContentArea.innerHTML = ''; // Clear loading message

                if (verifications && verifications.length > 0) {
                    verifications.forEach(verification => {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('knowledge-log-item');
                        
                        const metadata = verification.metadata || {};
                        const originalFactContent = verification.content || "[No original fact content]";
                        const lastVerifiedTimestamp = metadata.last_verified_timestamp;
                        const verificationAttemptFailed = metadata.verification_attempt_failed === true || metadata.verification_attempt_failed === 'true' || metadata.verification_attempt_failed === 1;
                        const isOutdated = metadata.status === 'outdated_by_upkeep';
                        const supersedingFactContent = metadata.superseding_fact_content;
                        const llmReasoning = metadata.reason; // Assuming 'reason' key from LLM verification

                        // 1. Timestamp
                        const timestampDiv = document.createElement('div');
                        timestampDiv.classList.add('log-timestamp');
                        if (lastVerifiedTimestamp) {
                            timestampDiv.textContent = `Verified: ${new Date(lastVerifiedTimestamp).toLocaleString()}`;
                        } else {
                            timestampDiv.textContent = `Verification Attempted: ${new Date(verification.timestamp).toLocaleString()}`; // Fallback to memory entry timestamp
                        }
                        itemDiv.appendChild(timestampDiv);

                        // 2. Original Fact
                        const factDiv = document.createElement('div');
                        factDiv.classList.add('log-fact');
                        const factStrong = document.createElement('strong');
                        factStrong.textContent = "Original Fact: ";
                        factDiv.appendChild(factStrong);
                        factDiv.appendChild(document.createTextNode(originalFactContent.substring(0, 200) + (originalFactContent.length > 200 ? "..." : "")));
                        itemDiv.appendChild(factDiv);

                        // 3. Status
                        const statusDiv = document.createElement('div');
                        statusDiv.classList.add('log-status');
                        let statusText = "Status Unknown";
                        let statusClass = "unverifiable"; // Default class

                        if (isOutdated && supersedingFactContent) {
                            statusText = "Updated";
                            statusClass = "updated";
                            itemDiv.style.borderLeftColor = "#FF9800"; // Orange for updated
                        } else if (verificationAttemptFailed) {
                            statusText = "Unverifiable / Error";
                            statusClass = "unverifiable";
                            itemDiv.style.borderLeftColor = "#F44336"; // Red for unverifiable
                        } else if (lastVerifiedTimestamp && !isOutdated) { // If it has a verification time and isn't outdated
                            statusText = "Confirmed Accurate";
                            statusClass = "accurate";
                            itemDiv.style.borderLeftColor = "#4CAF50"; // Green for accurate
                        } else {
                             itemDiv.style.borderLeftColor = "#757575"; // Grey for unknown/pending
                        }
                        
                        statusDiv.classList.add(statusClass);
                        statusDiv.textContent = `Status: ${statusText}`;
                        itemDiv.appendChild(statusDiv);

                        // 4. New Fact Statement (if updated)
                        if (isOutdated && supersedingFactContent && supersedingFactContent !== "[Content of new fact not found]") {
                            const newStatementDiv = document.createElement('div');
                            newStatementDiv.classList.add('log-new-statement');
                            const newFactStrong = document.createElement('strong');
                            newFactStrong.textContent = "Updated To: ";
                            newStatementDiv.appendChild(newFactStrong);
                            newStatementDiv.appendChild(document.createTextNode(supersedingFactContent.substring(0, 200) + (supersedingFactContent.length > 200 ? "..." : "")));
                            itemDiv.appendChild(newStatementDiv);
                        } else if (isOutdated && metadata.superseded_by_fact_id && !supersedingFactContent) {
                            const newStatementDiv = document.createElement('div');
                            newStatementDiv.classList.add('log-new-statement');
                            newStatementDiv.textContent = `Updated. New fact ID: ${metadata.superseded_by_fact_id}`;
                            itemDiv.appendChild(newStatementDiv);
                        }


                        // 5. LLM Reasoning (if available)
                        if (llmReasoning) {
                            const reasonDiv = document.createElement('div');
                            reasonDiv.style.fontSize = '0.9em';
                            reasonDiv.style.color = '#B0B0B0'; // Lighter grey for reasoning
                            reasonDiv.style.marginTop = '4px';
                            reasonDiv.style.paddingLeft = '10px';
                            reasonDiv.style.borderLeft = '2px dotted #555';
                            const reasonStrong = document.createElement('strong');
                            reasonStrong.textContent = "Details: ";
                            reasonDiv.appendChild(reasonStrong);
                            reasonDiv.appendChild(document.createTextNode(llmReasoning));
                            itemDiv.appendChild(reasonDiv);
                        }
                        
                        knowledgeLogContentArea.appendChild(itemDiv);
                    });
                } else {
                    knowledgeLogContentArea.innerHTML = '<p style="color: #888;">No knowledge upkeep activities found in the log.</p>';
                }
            } catch (error) {
                console.error("Error fetching or displaying knowledge verifications:", error);
                knowledgeLogContentArea.innerHTML = `<p style="color: #F44336;">Error: ${error.message}</p>`;
                showNotification(`Error fetching knowledge log: ${error.message}`, "error");
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- Assign ALL DOM Elements ---
            modelSelect = document.getElementById('model-select');
            systemPromptInput = document.getElementById('system-prompt-input');
            chatMessagesArea = document.getElementById('chat-messages-area');
            userInput = document.getElementById('user-input');
            sendButton = document.getElementById('send-button');
            resetChatButton = document.getElementById('reset-chat-button');
            uploadDocumentButton = document.getElementById('upload-document-button');
            documentInput = document.getElementById('document-input');
            uploadImageButton = document.getElementById('upload-image-button');
            imageInput = document.getElementById('image-input');
            systemPromptButton = document.getElementById('system-prompt-button');
            systemPromptPanel = document.getElementById('system-prompt-panel');
            systemPromptClose = document.getElementById('system-prompt-close');
            systemPromptSave = document.getElementById('system-prompt-save');
            historyButton = document.getElementById('history-button');
            historyPanel = document.getElementById('history-panel');
            historyCloseButton = document.getElementById('history-close-button');
            historyContentArea = document.getElementById('history-content-area');
            proactiveButton = document.getElementById('proactive-button');
            proactivePanel = document.getElementById('proactive-panel');
            proactiveCloseButton = document.getElementById('proactive-close-button');
            proactiveMessagesArea = document.getElementById('proactive-messages-area');
            clearProactiveButton = document.getElementById('clear-proactive-button');
            attachedDocumentIndicator = document.getElementById('attached-document-indicator');
            attachedDocumentNameSpan = document.getElementById('attached-document-name');
            removeAttachedDocumentButton = document.getElementById('remove-attached-document');
            dropdownButton = document.getElementById('model-dropdown-button');
            dropdownContent = document.getElementById('model-dropdown-content');
            modelDisplayName = document.getElementById('model-display-name');
            modelTemperatureInput = document.getElementById('model-temperature-input');
            contextLengthInput = document.getElementById('context-length-input');
            forceWebSearchButton = document.getElementById('force-web-search-button');
            getDailyBriefingButton = document.getElementById('get-daily-briefing-button'); 
            dailyBriefingPanel = document.getElementById('daily-briefing-panel');
            dailyBriefingCloseButton = document.getElementById('daily-briefing-close-button');
            dailyBriefingContentArea = document.getElementById('daily-briefing-content-area');
            refreshDailyBriefingButton = document.getElementById('refresh-daily-briefing-button');
            clearHistoryButton = document.getElementById('clear-history-button');
            clearUserMemoryButton = document.getElementById('clear-user-memory-button'); 
            clearBackendMemoryButton = document.getElementById('clear-backend-memory-button');
            apiUrlInput = document.getElementById('api-url-input');
            userIdInput = document.getElementById('user-id-input');
            weatherLocationInput = document.getElementById('weather-location-input');
            apiKeyInput = document.getElementById('api-key-input');
            llmProviderUrlInput = document.getElementById('llm-provider-url-input');
            weatherPanel = document.getElementById('weather-panel');
            weatherLocationDisplay = document.getElementById('weather-location');
            weatherDescriptionDisplay = document.getElementById('weather-description');
            weatherTemperatureDisplay = document.getElementById('weather-temperature');
            weatherLastUpdatedDisplay = document.getElementById('weather-last-updated');
            weatherHumidityDisplay = document.getElementById('weather-humidity');
            weatherWindDisplay = document.getElementById('weather-wind');
            weatherUpdateButton = document.getElementById('weather-update-button');
            weatherCloseButton = document.getElementById('weather-close');
            microphoneButton = document.getElementById('microphone-button'); 
            learningLogButton = document.getElementById('learning-log-button');
            learningLogPanel = document.getElementById('learning-log-panel');
            learningLogCloseButton = document.getElementById('learning-log-close-button');
            learningLogContentArea = document.getElementById('learning-log-content-area');
            refreshLearningLogButton = document.getElementById('refresh-learning-log-button');
            clearLearningLogDisplayButton = document.getElementById('clear-learning-log-display-button');
            dreamJournalButton = document.getElementById('dream-journal-button');
            dreamJournalPanel = document.getElementById('dream-journal-panel');
            dreamJournalCloseButton = document.getElementById('dream-journal-close-button');
            dreamJournalContentArea = document.getElementById('dream-journal-content-area');
            refreshDreamJournalButton = document.getElementById('refresh-dream-journal-button');
            clearDreamJournalDisplayButton = document.getElementById('clear-dream-journal-display-button');
            knowledgeLogButton = document.getElementById('knowledge-log-button');
            knowledgeLogPanel = document.getElementById('knowledge-log-panel');
            knowledgeLogCloseButton = document.getElementById('knowledge-log-close-button');
            knowledgeLogContentArea = document.getElementById('knowledge-log-content-area');
            refreshKnowledgeLogButton = document.getElementById('refresh-knowledge-log-button');
            clearKnowledgeLogDisplayButton = document.getElementById('clear-knowledge-log-display-button');
            knowledgeLogButton = document.getElementById('knowledge-log-button');
            knowledgeLogPanel = document.getElementById('knowledge-log-panel');
            knowledgeLogCloseButton = document.getElementById('knowledge-log-close-button');
            knowledgeLogContentArea = document.getElementById('knowledge-log-content-area');
            refreshKnowledgeLogButton = document.getElementById('refresh-knowledge-log-button');
            clearKnowledgeLogDisplayButton = document.getElementById('clear-knowledge-log-display-button');
            

            // --- Load Settings and Initialize ---
            const savedApiUrl = localStorage.getItem(EIDOS_API_BASE_URL_KEY);
            if (savedApiUrl) { EIDOS_API_BASE_URL = savedApiUrl; console.log("Loaded API Base URL:", EIDOS_API_BASE_URL); }
            else { console.log("No API Base URL in localStorage. Using default:", EIDOS_API_BASE_URL); }
            if (apiUrlInput) apiUrlInput.value = EIDOS_API_BASE_URL;

            const savedApiKey = localStorage.getItem(EIDOS_API_KEY_KEY);
            if (savedApiKey && apiKeyInput) { apiKeyInput.value = savedApiKey; console.log("Loaded API Key."); }
            else { console.log("No API Key in localStorage."); }

            const savedUserId = localStorage.getItem(USER_ID_KEY);
            if (savedUserId) { currentUserId = savedUserId; console.log("Loaded User ID:", currentUserId); }
            else { currentUserId = `user_${Math.random().toString(36).substring(2, 9)}`; localStorage.setItem(USER_ID_KEY, currentUserId); console.log("Generated User ID:", currentUserId); }
            if (userIdInput) userIdInput.value = currentUserId;

            const savedWeatherLocation = localStorage.getItem(WEATHER_LOCATION_KEY);
            if (savedWeatherLocation && weatherLocationInput) { weatherLocationInput.value = savedWeatherLocation; console.log("Loaded Weather Location:", savedWeatherLocation); }
            else { console.log("No Weather Location in localStorage."); }

            const savedModelTemperature = localStorage.getItem(MODEL_TEMPERATURE_KEY);
            if (savedModelTemperature !== null && modelTemperatureInput) {
                 const tempValue = parseFloat(savedModelTemperature);
                 if (!isNaN(tempValue)) { modelTemperatureInput.value = tempValue; console.log("Loaded Model Temperature:", tempValue); }
                 else { console.warn("Invalid Model Temperature in localStorage:", savedModelTemperature); }
            } else if (modelTemperatureInput) { console.log("No Model Temperature in localStorage. Using default:", modelTemperatureInput.value); }

            const savedContextLength = localStorage.getItem(EIDOS_CONTEXT_LENGTH_KEY);
            if (savedContextLength !== null && contextLengthInput) {
                const lengthValue = parseInt(savedContextLength, 10);
                if (!isNaN(lengthValue)) { contextLengthInput.value = lengthValue; console.log("Loaded Context Length:", lengthValue); }
                else { console.warn("Invalid Context Length in localStorage:", savedContextLength); }
            } else if (contextLengthInput) { console.log("No Context Length in localStorage. Using placeholder."); }

            const savedLlmProviderUrl = localStorage.getItem(LLM_PROVIDER_URL_KEY);
            if (savedLlmProviderUrl && llmProviderUrlInput) { llmProviderUrlInput.value = savedLlmProviderUrl; console.log("Loaded LLM Provider URL:", savedLlmProviderUrl); }
            else { console.log("No LLM Provider URL in localStorage."); }


            if (systemPromptInput) systemPromptInput.value = localStorage.getItem(SYSTEM_PROMPT_KEY) || "";
            console.log("Current User ID for session:", currentUserId);

            fetchModels(); 
            if (userInput) {
                userInput.focus();
                userInput.addEventListener('input', () => autoAdjustTextareaHeight(userInput));
                autoAdjustTextareaHeight(userInput); 
            }
            Prism.plugins.autoloader.languages_path = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/';
            expandChatInterface(); 
            renderHistoryPanel();
            connectWebSocket();
            setupWeatherUpdates();
            speechRecognition = initializeSpeechRecognition();
            
            // --- Event Listeners ---
            if (sendButton) sendButton.addEventListener('click', () => sendMessage());
            if (resetChatButton) resetChatButton.addEventListener('click', resetChat);
            if (userInput) {
                userInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }
                });
            }
            if (forceWebSearchButton) {
                forceWebSearchButton.addEventListener('click', () => {
                    const prefix = "[FORCE_WEB_SEARCH] ";
                    sendMessage(prefix);
                });
            }

            if (uploadDocumentButton) uploadDocumentButton.addEventListener('click', () => { if (documentInput) documentInput.click(); });
            if (documentInput) { documentInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (file) handleDocumentUpload(file); }); }
            if (uploadImageButton) uploadImageButton.addEventListener('click', () => { if (imageInput) imageInput.click(); });
            if (imageInput) { imageInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (file) handleImageUpload(file); }); }
            if (removeAttachedDocumentButton) removeAttachedDocumentButton.addEventListener('click', removeAttachedDocument);
            if (microphoneButton) microphoneButton.addEventListener('click', toggleListening);


            // --- Panel Open/Close Logic (Corrected) ---
            const allPanelElements = [systemPromptPanel, historyPanel, proactivePanel, dailyBriefingPanel, learningLogPanel, dreamJournalPanel, knowledgeLogPanel].filter(p => p);
            
            function closeAllPanels() {
                allPanelElements.forEach(p => p?.classList.remove('open'));
            }

            function togglePanel(panelElement, fetchFunction) {
                if (!panelElement) return;
                const isOpen = panelElement.classList.contains('open');
                
                allPanelElements.forEach(p => { 
                    if (p && p !== panelElement) p.classList.remove('open'); 
                }); 

                if (isOpen) {
                    panelElement.classList.remove('open');
                } else {
                    panelElement.classList.add('open');
                    if (fetchFunction) fetchFunction();
                    if (panelElement.id === 'system-prompt-panel') {
                         const firstInputField = systemPromptPanel ? systemPromptPanel.querySelector('input[type="text"], input[type="password"], input[type="number"], textarea') : null; 
                         if (firstInputField) setTimeout(() => { firstInputField.focus(); }, 300);
                    }
                }
            }

            // Panel Opening Buttons
            if (systemPromptButton) systemPromptButton.addEventListener('click', (e) => { e.stopPropagation(); togglePanel(systemPromptPanel); });
            if (historyButton) historyButton.addEventListener('click', (e) => { e.stopPropagation(); togglePanel(historyPanel, renderHistoryPanel); });
            if (proactiveButton) proactiveButton.addEventListener('click', (e) => { e.stopPropagation(); togglePanel(proactivePanel); });
            if (learningLogButton) learningLogButton.addEventListener('click', (e) => { e.stopPropagation(); togglePanel(learningLogPanel, fetchAndDisplayLearnings); });
            if (dreamJournalButton) dreamJournalButton.addEventListener('click', (e) => { e.stopPropagation(); togglePanel(dreamJournalPanel, fetchAndDisplayDreams); });
            if (knowledgeLogButton) knowledgeLogButton.addEventListener('click', (e) => { e.stopPropagation(); togglePanel(knowledgeLogPanel, fetchAndDisplayKnowledgeVerifications); });
            if (getDailyBriefingButton) {
                getDailyBriefingButton.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    togglePanel(dailyBriefingPanel, fetchAndDisplayDailyBriefing);
                });
            }

            // Explicit Close buttons for each panel
            const panelCloseButtons = [
                { button: systemPromptClose, panel: systemPromptPanel },
                { button: historyCloseButton, panel: historyPanel },
                { button: proactiveCloseButton, panel: proactivePanel },
                { button: dailyBriefingCloseButton, panel: dailyBriefingPanel },
                { button: learningLogCloseButton, panel: learningLogPanel },
                { button: dreamJournalCloseButton, panel: dreamJournalPanel },
                { button: knowledgeLogCloseButton, panel: knowledgeLogPanel }
            ];

            panelCloseButtons.forEach(item => {
                if (item.button && item.panel) {
                    item.button.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        item.panel.classList.remove('open');
                    });
                }
            });
            // --- End Corrected Panel Close Logic ---


            // Refresh and Clear buttons
            if (refreshDailyBriefingButton) refreshDailyBriefingButton.addEventListener('click', fetchAndDisplayDailyBriefing);
            if (refreshLearningLogButton) refreshLearningLogButton.addEventListener('click', fetchAndDisplayLearnings);
            if (clearLearningLogDisplayButton) clearLearningLogDisplayButton.addEventListener('click', () => { if(learningLogContentArea) learningLogContentArea.innerHTML = '<p style="color: #888;">Display cleared. Click Refresh to reload.</p>'; });
            if (refreshDreamJournalButton) refreshDreamJournalButton.addEventListener('click', fetchAndDisplayDreams);
            if (clearDreamJournalDisplayButton) clearDreamJournalDisplayButton.addEventListener('click', () => { if(dreamJournalContentArea) dreamJournalContentArea.innerHTML = '<p style="color: #888;">Display cleared. Click Refresh to reload.</p>'; });
            if (refreshKnowledgeLogButton) refreshKnowledgeLogButton.addEventListener('click', fetchAndDisplayKnowledgeVerifications);
            if (clearKnowledgeLogDisplayButton) clearKnowledgeLogDisplayButton.addEventListener('click', () => { if(knowledgeLogContentArea) knowledgeLogContentArea.innerHTML = '<p style="color: #888;">Display cleared. Click Refresh to reload.</p>'; });
            if (clearProactiveButton) clearProactiveButton.addEventListener('click', () => { if (proactiveMessagesArea) proactiveMessagesArea.innerHTML = '<p style="color: #888;">No proactive messages yet.</p>'; showNotification('Proactive messages display cleared.', 'info'); });


            // Settings Save Button
            if (systemPromptSave) {
                systemPromptSave.addEventListener('click', async () => {
                     if (systemPromptInput) { localStorage.setItem(SYSTEM_PROMPT_KEY, systemPromptInput.value.trim()); }
                     if (modelTemperatureInput) { const tempValue = parseFloat(modelTemperatureInput.value); if (!isNaN(tempValue)) { localStorage.setItem(MODEL_TEMPERATURE_KEY, tempValue.toString()); } else { showNotification('Invalid Model Temperature value.', 'error'); } }

                     let llmSettingsChanged = false;
                     if (llmProviderUrlInput) {
                         const newUrl = llmProviderUrlInput.value.trim();
                         const oldUrl = localStorage.getItem(LLM_PROVIDER_URL_KEY);
                         if (newUrl && newUrl.startsWith('http')) { 
                             if (newUrl !== oldUrl) {
                                 localStorage.setItem(LLM_PROVIDER_URL_KEY, newUrl);
                                 llmSettingsChanged = true;
                             }
                         } else if (!newUrl && oldUrl) { 
                             localStorage.removeItem(LLM_PROVIDER_URL_KEY);
                             llmSettingsChanged = true;
                         } else if (newUrl && !newUrl.startsWith('http')) {
                             showNotification('Invalid LLM Provider URL format. Must start with http(s).', 'warning');
                             if (llmProviderUrlInput) llmProviderUrlInput.value = oldUrl || ''; 
                         }
                     }
                     
                     let apiUrlChanged = false;
                     if (apiUrlInput) { const newApiUrl = apiUrlInput.value.trim(); if (newApiUrl && newApiUrl.startsWith('http') && newApiUrl !== EIDOS_API_BASE_URL) { localStorage.setItem(EIDOS_API_BASE_URL_KEY, newApiUrl); EIDOS_API_BASE_URL = newApiUrl; apiUrlChanged = true; } else if (!newApiUrl) { showNotification('API Base URL cannot be empty.', 'warning'); if (apiUrlInput) apiUrlInput.value = EIDOS_API_BASE_URL; } else if (newApiUrl && !newApiUrl.startsWith('http')) { showNotification('Invalid API Base URL format.', 'warning'); if (apiUrlInput) apiUrlInput.value = EIDOS_API_BASE_URL; } }
                     if (apiKeyInput) { const newApiKey = apiKeyInput.value.trim(); if (newApiKey) { localStorage.setItem(EIDOS_API_KEY_KEY, newApiKey); } else { localStorage.removeItem(EIDOS_API_KEY_KEY); } }
                     let userIdChanged = false;
                     if (userIdInput) { const newUserId = userIdInput.value.trim(); if (newUserId && newUserId !== currentUserId) { localStorage.setItem(USER_ID_KEY, newUserId); currentUserId = newUserId; userIdChanged = true; } else if (!newUserId) { showNotification('User ID cannot be empty.', 'warning'); if (userIdInput) userIdInput.value = currentUserId; } }
                     let weatherLocationSavedOrChangedToLocalStorage = false;
                     if (weatherLocationInput) { const newWeatherLocation = weatherLocationInput.value.trim(); const oldWeatherLocation = localStorage.getItem(WEATHER_LOCATION_KEY); if (newWeatherLocation && newWeatherLocation !== oldWeatherLocation) { localStorage.setItem(WEATHER_LOCATION_KEY, newWeatherLocation); weatherLocationSavedOrChangedToLocalStorage = true; } else if (!newWeatherLocation && oldWeatherLocation) { localStorage.removeItem(WEATHER_LOCATION_KEY); if (weatherPanel) weatherPanel.style.display = 'none'; weatherLocationSavedOrChangedToLocalStorage = true; } }

                     if (contextLengthInput) {
                         const lengthValueStr = contextLengthInput.value.trim();
                         if (lengthValueStr) {
                            const lengthValue = parseInt(lengthValueStr, 10);
                            if (!isNaN(lengthValue) && lengthValue >= 256 && lengthValue <= 32000) {
                                localStorage.setItem(EIDOS_CONTEXT_LENGTH_KEY, lengthValue.toString());
                            } else {
                                showNotification('Invalid Context Length. Please enter a number between 256 and 32000.', 'error');
                            }
                         } else {
                            localStorage.removeItem(EIDOS_CONTEXT_LENGTH_KEY);
                            console.log("Context Length cleared from localStorage, will use LLM default.");
                         }
                     }

                    const settingsToSync = [];
                    if (weatherLocationInput && weatherLocationInput.value.trim()) { settingsToSync.push({ attribute_name: "preferred_location", attribute_value: weatherLocationInput.value.trim(), user_statement_context: "User set default weather location via GUI settings." }); }
                    if (systemPromptInput && systemPromptInput.value.trim()) { settingsToSync.push({ attribute_name: "system_prompt_preference", attribute_value: systemPromptInput.value.trim(), user_statement_context: "User set system prompt preference via GUI settings." }); }
                    if (userIdInput && userIdInput.value.trim()) { settingsToSync.push({ attribute_name: "user_identifier_preference", attribute_value: userIdInput.value.trim(), user_statement_context: "User set their preferred identifier via GUI settings." }); }
                    if (llmProviderUrlInput && llmProviderUrlInput.value.trim() && llmProviderUrlInput.value.trim().startsWith('http')) { settingsToSync.push({ attribute_name: "llm_provider_url_preference", attribute_value: llmProviderUrlInput.value.trim(), user_statement_context: "User set preferred LLM provider URL via GUI settings." }); }
                    
                    if (settingsToSync.length > 0) {
                        try {
                            const settingsPayload = { user_id: currentUserId, settings: settingsToSync };
                            const urlForUserSettings = `${EIDOS_API_BASE_URL}/user/settings`;
                            const response = await fetch(urlForUserSettings, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-User-Id': currentUserId }, body: JSON.stringify(settingsPayload) });
                            const responseData = await response.json();
                            if (response.ok && responseData.status === "success") { console.log("User settings successfully synced with backend.", responseData.details); }
                            else { console.error(`Failed to sync user settings with backend. URL: ${urlForUserSettings}, Status: ${response.status}`, responseData); showNotification(`Failed to save some settings to backend: ${responseData.message || response.statusText || 'Unknown error'}`, 'error'); }
                        } catch (error) { const attemptedUrl = `${EIDOS_API_BASE_URL}/user/settings`; console.error(`Error sending user settings to backend. Attempted URL: ${attemptedUrl}`, error); showNotification(`Error saving settings to backend: ${error.message}`, 'error'); }
                    }

                     if (apiUrlChanged || userIdChanged) { if (eidosWebSocket && eidosWebSocket.readyState !== WebSocket.CLOSED) { eidosWebSocket.close(1000, "Settings changed"); } setTimeout(connectWebSocket, 100); }
                     if (llmSettingsChanged) { fetchModels(); } 
                     if (weatherLocationSavedOrChangedToLocalStorage) { setupWeatherUpdates(); }
                     if (systemPromptPanel) systemPromptPanel.classList.remove('open');
                     showNotification('Settings saved to browser. Backend sync initiated where applicable.', 'success');
                 });
             }

            // Memory Clear Buttons
            if (clearHistoryButton) { clearHistoryButton.addEventListener('click', clearAllLocalChatHistory); } 
            if (clearUserMemoryButton) { clearUserMemoryButton.addEventListener('click', clearUserBackendMemory); } 
            if (clearBackendMemoryButton) { clearBackendMemoryButton.addEventListener('click', clearEidosBackendMemory); } 
            
            // Global click listener to close panels/dropdowns (Corrected)
            document.addEventListener('click', (event) => {
                const allPanelElements = [systemPromptPanel, historyPanel, proactivePanel, dailyBriefingPanel, learningLogPanel, dreamJournalPanel, knowledgeLogPanel].filter(p => p);
                const allButtonElementsThatOpenPanels = [systemPromptButton, historyButton, proactiveButton, getDailyBriefingButton, learningLogButton, dreamJournalButton, knowledgeLogButton].filter(b => b);

                let clickedOnAButtonThatOpensAPanel = allButtonElementsThatOpenPanels.some(button => button && button.contains(event.target));
                let clickedInsideAnOpenPanel = allPanelElements.some(panel => panel && panel.classList.contains('open') && panel.contains(event.target));
                
                if (!clickedOnAButtonThatOpensAPanel && !clickedInsideAnOpenPanel) {
                    closeAllPanels();
                }
                
                if (dropdownButton && dropdownContent && dropdownContent.style.display === 'block') {
                     if (!dropdownButton.contains(event.target) && !dropdownContent.contains(event.target)) {
                         dropdownContent.style.display = 'none';
                     }
                }
            });
            // --- End Corrected Global Click Listener ---


            // Escape key listener
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    allPanelElements.forEach(p => p?.classList.remove('open'));
                    if (dropdownContent && dropdownContent.style.display === 'block') dropdownContent.style.display = 'none';
                }
            });

            // Dropdown button listener
            if (dropdownButton) {
                dropdownButton.addEventListener('click', function(event) {
                     event.stopPropagation();
                     if (dropdownContent) {
                         const isDropdownOpen = dropdownContent.style.display === 'block';
                         allPanelElements.forEach(p => p?.classList.remove('open')); 
                         dropdownContent.style.display = isDropdownOpen ? 'none' : 'block';
                     }
                });
            }

            // Drag and Drop
            const dropTarget = document.querySelector('.input-container');
            if (dropTarget) {
                dropTarget.addEventListener('dragover', (event) => { event.preventDefault(); event.stopPropagation(); dropTarget.classList.add('drag-over'); });
                dropTarget.addEventListener('dragleave', (event) => { event.preventDefault(); event.stopPropagation(); dropTarget.classList.remove('drag-over'); });
                dropTarget.addEventListener('drop', (event) => {
                    event.preventDefault(); event.stopPropagation(); dropTarget.classList.remove('drag-over');
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0]; const fileName = file.name; const fileExtension = fileName.split('.').pop().toLowerCase();
                        if (['pdf', 'docx', 'txt'].includes(fileExtension)) { handleDocumentUpload(file); }
                        else if (file.type.startsWith('image/')) { handleImageUpload(file); }
                        else { showNotification(`Unsupported file type for drag and drop: .${fileExtension}`, 'warning'); }
                    }
                });
            } else { console.error("Drag and drop target (.input-container) not found!"); }

        }); 

        window.addEventListener('beforeunload', saveChatToHistory);

        if (!RegExp.escape) {
            RegExp.escape = function(string) {
                return string.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            };
        }

    </script>
</body>
</html>